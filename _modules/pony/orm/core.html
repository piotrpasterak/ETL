
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pony.orm.core &#8212; ETL Project 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pony.orm.core</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">pony.py23compat</span> <span class="k">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">izip</span><span class="p">,</span> <span class="n">imap</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span><span class="p">,</span> <span class="n">items_list</span><span class="p">,</span> <span class="n">values_list</span><span class="p">,</span> <span class="n">xrange</span><span class="p">,</span> <span class="nb">cmp</span><span class="p">,</span> \
                            <span class="n">basestring</span><span class="p">,</span> <span class="n">unicode</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">int_types</span><span class="p">,</span> <span class="n">builtins</span><span class="p">,</span> <span class="n">with_metaclass</span>

<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">types</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">attrgetter</span><span class="p">,</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">starmap</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="k">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">randint</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">RLock</span><span class="p">,</span> <span class="n">currentThread</span> <span class="k">as</span> <span class="n">current_thread</span><span class="p">,</span> <span class="n">_MainThread</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">isgeneratorfunction</span>

<span class="kn">from</span> <span class="nn">pony.thirdparty.compiler</span> <span class="k">import</span> <span class="n">ast</span><span class="p">,</span> <span class="n">parse</span>

<span class="kn">import</span> <span class="nn">pony</span>
<span class="kn">from</span> <span class="nn">pony</span> <span class="k">import</span> <span class="n">options</span>
<span class="kn">from</span> <span class="nn">pony.orm.decompiling</span> <span class="k">import</span> <span class="n">decompile</span>
<span class="kn">from</span> <span class="nn">pony.orm.ormtypes</span> <span class="k">import</span> <span class="n">LongStr</span><span class="p">,</span> <span class="n">LongUnicode</span><span class="p">,</span> <span class="n">numeric_types</span><span class="p">,</span> <span class="n">RawSQL</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">Json</span><span class="p">,</span> <span class="n">TrackedValue</span><span class="p">,</span> <span class="n">QueryType</span>
<span class="kn">from</span> <span class="nn">pony.orm.asttranslation</span> <span class="k">import</span> <span class="n">ast2src</span><span class="p">,</span> <span class="n">create_extractors</span><span class="p">,</span> <span class="n">TranslationError</span>
<span class="kn">from</span> <span class="nn">pony.orm.dbapiprovider</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">DBAPIProvider</span><span class="p">,</span> <span class="n">DBException</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">DataError</span><span class="p">,</span>
    <span class="n">OperationalError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InternalError</span><span class="p">,</span> <span class="n">ProgrammingError</span><span class="p">,</span> <span class="n">NotSupportedError</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">pony</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">pony.utils</span> <span class="k">import</span> <span class="n">localbase</span><span class="p">,</span> <span class="n">decorator</span><span class="p">,</span> <span class="n">cut_traceback</span><span class="p">,</span> <span class="n">cut_traceback_depth</span><span class="p">,</span> <span class="n">throw</span><span class="p">,</span> <span class="n">reraise</span><span class="p">,</span> <span class="n">truncate_repr</span><span class="p">,</span> \
     <span class="n">get_lambda_args</span><span class="p">,</span> <span class="n">pickle_ast</span><span class="p">,</span> <span class="n">unpickle_ast</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">import_module</span><span class="p">,</span> <span class="n">parse_expr</span><span class="p">,</span> <span class="n">is_ident</span><span class="p">,</span> <span class="n">tostring</span><span class="p">,</span> <span class="n">strjoin</span><span class="p">,</span> \
     <span class="n">between</span><span class="p">,</span> <span class="n">concat</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">,</span> <span class="n">HashableDict</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;pony&#39;</span><span class="p">,</span>

    <span class="s1">&#39;DBException&#39;</span><span class="p">,</span> <span class="s1">&#39;RowNotFound&#39;</span><span class="p">,</span> <span class="s1">&#39;MultipleRowsFound&#39;</span><span class="p">,</span> <span class="s1">&#39;TooManyRowsFound&#39;</span><span class="p">,</span>

    <span class="s1">&#39;Warning&#39;</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;InterfaceError&#39;</span><span class="p">,</span> <span class="s1">&#39;DatabaseError&#39;</span><span class="p">,</span> <span class="s1">&#39;DataError&#39;</span><span class="p">,</span> <span class="s1">&#39;OperationalError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IntegrityError&#39;</span><span class="p">,</span> <span class="s1">&#39;InternalError&#39;</span><span class="p">,</span> <span class="s1">&#39;ProgrammingError&#39;</span><span class="p">,</span> <span class="s1">&#39;NotSupportedError&#39;</span><span class="p">,</span>

    <span class="s1">&#39;OrmError&#39;</span><span class="p">,</span> <span class="s1">&#39;ERDiagramError&#39;</span><span class="p">,</span> <span class="s1">&#39;DBSchemaError&#39;</span><span class="p">,</span> <span class="s1">&#39;MappingError&#39;</span><span class="p">,</span> <span class="s1">&#39;BindingError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TableDoesNotExist&#39;</span><span class="p">,</span> <span class="s1">&#39;TableIsNotEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;ConstraintError&#39;</span><span class="p">,</span> <span class="s1">&#39;CacheIndexError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ObjectNotFound&#39;</span><span class="p">,</span> <span class="s1">&#39;MultipleObjectsFoundError&#39;</span><span class="p">,</span> <span class="s1">&#39;TooManyObjectsFoundError&#39;</span><span class="p">,</span> <span class="s1">&#39;OperationWithDeletedObjectError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TransactionError&#39;</span><span class="p">,</span> <span class="s1">&#39;ConnectionClosedError&#39;</span><span class="p">,</span> <span class="s1">&#39;TransactionIntegrityError&#39;</span><span class="p">,</span> <span class="s1">&#39;IsolationError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CommitException&#39;</span><span class="p">,</span> <span class="s1">&#39;RollbackException&#39;</span><span class="p">,</span> <span class="s1">&#39;UnrepeatableReadError&#39;</span><span class="p">,</span> <span class="s1">&#39;OptimisticCheckError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UnresolvableCyclicDependency&#39;</span><span class="p">,</span> <span class="s1">&#39;UnexpectedError&#39;</span><span class="p">,</span> <span class="s1">&#39;DatabaseSessionIsOver&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DatabaseContainsIncorrectValue&#39;</span><span class="p">,</span> <span class="s1">&#39;DatabaseContainsIncorrectEmptyValue&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TranslationError&#39;</span><span class="p">,</span> <span class="s1">&#39;ExprEvalError&#39;</span><span class="p">,</span> <span class="s1">&#39;PermissionError&#39;</span><span class="p">,</span>

    <span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="s1">&#39;sql_debug&#39;</span><span class="p">,</span> <span class="s1">&#39;set_sql_debug&#39;</span><span class="p">,</span> <span class="s1">&#39;sql_debugging&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span>

    <span class="s1">&#39;PrimaryKey&#39;</span><span class="p">,</span> <span class="s1">&#39;Required&#39;</span><span class="p">,</span> <span class="s1">&#39;Optional&#39;</span><span class="p">,</span> <span class="s1">&#39;Set&#39;</span><span class="p">,</span> <span class="s1">&#39;Discriminator&#39;</span><span class="p">,</span>
    <span class="s1">&#39;composite_key&#39;</span><span class="p">,</span> <span class="s1">&#39;composite_index&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flush&#39;</span><span class="p">,</span> <span class="s1">&#39;commit&#39;</span><span class="p">,</span> <span class="s1">&#39;rollback&#39;</span><span class="p">,</span> <span class="s1">&#39;db_session&#39;</span><span class="p">,</span> <span class="s1">&#39;with_transaction&#39;</span><span class="p">,</span>

    <span class="s1">&#39;LongStr&#39;</span><span class="p">,</span> <span class="s1">&#39;LongUnicode&#39;</span><span class="p">,</span> <span class="s1">&#39;Json&#39;</span><span class="p">,</span>

    <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;left_join&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>

    <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;group_concat&#39;</span><span class="p">,</span> <span class="s1">&#39;distinct&#39;</span><span class="p">,</span>

    <span class="s1">&#39;JOIN&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span> <span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="s1">&#39;coalesce&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_sql&#39;</span><span class="p">,</span>

    <span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;unicode&#39;</span><span class="p">,</span>

    <span class="s1">&#39;get_current_user&#39;</span><span class="p">,</span> <span class="s1">&#39;set_current_user&#39;</span><span class="p">,</span> <span class="s1">&#39;perm&#39;</span><span class="p">,</span> <span class="s1">&#39;has_perm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_user_groups&#39;</span><span class="p">,</span> <span class="s1">&#39;get_user_roles&#39;</span><span class="p">,</span> <span class="s1">&#39;get_object_labels&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user_groups_getter&#39;</span><span class="p">,</span> <span class="s1">&#39;user_roles_getter&#39;</span><span class="p">,</span> <span class="s1">&#39;obj_labels_getter&#39;</span>
<span class="p">]</span>

<span class="n">suppress_debug_change</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">sql_debug</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="c1"># todo: make sql_debug deprecated</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_debug_change</span><span class="p">:</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">set_sql_debug</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_debug_change</span><span class="p">:</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="n">show_values</span>


<span class="n">orm_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pony.orm&#39;</span><span class="p">)</span>
<span class="n">sql_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pony.orm.sql&#39;</span><span class="p">)</span>

<span class="n">orm_log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>

<span class="k">def</span> <span class="nf">has_handlers</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PY2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">logger</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">log_orm</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">has_handlers</span><span class="p">(</span><span class="n">orm_logger</span><span class="p">):</span>
        <span class="n">orm_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">orm_log_level</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;EXECUTEMANY (</span><span class="si">%d</span><span class="s1">)</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">),</span> <span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_handlers</span><span class="p">(</span><span class="n">sql_logger</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="ow">and</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">format_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
        <span class="n">sql_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">orm_log_level</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">local</span><span class="o">.</span><span class="n">show_values</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">format_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">format_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span> <span class="k">return</span> <span class="n">args2str</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args2str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">args2str</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

<span class="n">adapted_sql_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">string2ast_cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">OrmError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ERDiagramError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">DBSchemaError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">MappingError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">BindingError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">TableDoesNotExist</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TableIsNotEmpty</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ConstraintError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">CacheIndexError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RowNotFound</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">MultipleRowsFound</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TooManyRowsFound</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ObjectNotFound</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">pkval</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">pkval</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">OrmError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">pkval</span> <span class="o">=</span> <span class="n">pkval</span>

<span class="k">class</span> <span class="nc">MultipleObjectsFoundError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TooManyObjectsFoundError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">OperationWithDeletedObjectError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TransactionError</span><span class="p">(</span><span class="n">OrmError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ConnectionClosedError</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">TransactionIntegrityError</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">original_exc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">original_exc</span> <span class="o">=</span> <span class="n">original_exc</span>

<span class="k">class</span> <span class="nc">CommitException</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>

<span class="k">class</span> <span class="nc">PartialCommitException</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>

<span class="k">class</span> <span class="nc">RollbackException</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>

<span class="k">class</span> <span class="nc">DatabaseSessionIsOver</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">TransactionRolledBack</span> <span class="o">=</span> <span class="n">DatabaseSessionIsOver</span>

<span class="k">class</span> <span class="nc">IsolationError</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span>   <span class="nc">UnrepeatableReadError</span><span class="p">(</span><span class="n">IsolationError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span>   <span class="nc">OptimisticCheckError</span><span class="p">(</span><span class="n">IsolationError</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">UnresolvableCyclicDependency</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UnexpectedError</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">original_exc</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">original_exc</span> <span class="o">=</span> <span class="n">original_exc</span>

<span class="k">class</span> <span class="nc">ExprEvalError</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">cause</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` raises </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">cause</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cause</span><span class="p">))</span>
        <span class="n">TranslationError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">exc</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span>

<span class="k">class</span> <span class="nc">PonyInternalException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">OptimizationFailed</span><span class="p">(</span><span class="n">PonyInternalException</span><span class="p">):</span>
    <span class="k">pass</span>  <span class="c1"># Internal exception, cannot be encountered in user code</span>

<span class="k">class</span> <span class="nc">UseAnotherTranslator</span><span class="p">(</span><span class="n">PonyInternalException</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">translator</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;This exception should be catched internally by PonyORM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">translator</span>

<span class="k">class</span> <span class="nc">DatabaseContainsIncorrectValue</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DatabaseContainsIncorrectEmptyValue</span><span class="p">(</span><span class="n">DatabaseContainsIncorrectValue</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">adapt_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">paramstyle</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">adapted_sql_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">paramstyle</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">original_sql</span> <span class="o">=</span> <span class="n">sql</span>
    <span class="k">if</span> <span class="n">paramstyle</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;pyformat&#39;</span><span class="p">):</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">:])</span>
            <span class="k">break</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$&#39;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parse_expr</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="c1"># TODO</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;&lt;?&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>  <span class="c1"># expr correction check</span>
            <span class="k">if</span> <span class="n">paramstyle</span> <span class="o">==</span> <span class="s1">&#39;qmark&#39;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">paramstyle</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">paramstyle</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">paramstyle</span> <span class="o">==</span> <span class="s1">&#39;named&#39;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;p</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">paramstyle</span> <span class="o">==</span> <span class="s1">&#39;pyformat&#39;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;p</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)s&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">adapted_sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">,)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;&lt;?&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adapted_sql</span> <span class="o">=</span> <span class="n">original_sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$$&#39;</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;?&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">adapted_sql</span><span class="p">,</span> <span class="n">code</span>
    <span class="n">adapted_sql_cache</span><span class="p">[(</span><span class="n">sql</span><span class="p">,</span> <span class="n">paramstyle</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">Local</span><span class="p">(</span><span class="n">localbase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">local</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">local</span><span class="o">.</span><span class="n">user_groups_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">local</span><span class="o">.</span><span class="n">user_roles_cache</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">push_debug_state</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">show_values</span><span class="p">):</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">local</span><span class="o">.</span><span class="n">show_values</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_debug_change</span><span class="p">:</span>
            <span class="n">local</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
            <span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="n">show_values</span>
    <span class="k">def</span> <span class="nf">pop_debug_state</span><span class="p">(</span><span class="n">local</span><span class="p">):</span>
        <span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">local</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">debug_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="n">local</span> <span class="o">=</span> <span class="n">Local</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_get_caches</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">cache</span> <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                       <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cache</span> <span class="p">:</span> <span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">cache</span><span class="o">.</span><span class="n">num</span><span class="p">)))</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">flush</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_get_caches</span><span class="p">():</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">transact_reraise</span><span class="p">(</span><span class="n">exc_class</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_exc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">TransactionError</span><span class="p">):</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">new_exc</span> <span class="o">=</span> <span class="n">exc_class</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
        <span class="n">new_exc</span><span class="o">.</span><span class="n">__cause__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reraise</span><span class="p">(</span><span class="n">exc_class</span><span class="p">,</span> <span class="n">new_exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span> <span class="k">del</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">new_exc</span>

<span class="k">def</span> <span class="nf">rollback_and_reraise</span><span class="p">(</span><span class="n">exc_info</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rollback</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">commit</span><span class="p">():</span>
    <span class="n">caches</span> <span class="o">=</span> <span class="n">_get_caches</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">caches</span><span class="p">:</span> <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">caches</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">rollback_and_reraise</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

    <span class="n">primary_cache</span> <span class="o">=</span> <span class="n">caches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">other_caches</span> <span class="o">=</span> <span class="n">caches</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">primary_cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">other_caches</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="n">transact_reraise</span><span class="p">(</span><span class="n">CommitException</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">other_caches</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="n">transact_reraise</span><span class="p">(</span><span class="n">PartialCommitException</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exceptions</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_get_caches</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="n">transact_reraise</span><span class="p">(</span><span class="n">RollbackException</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exceptions</span>

<span class="n">select_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*select\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DBSessionContextManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;retry&#39;</span><span class="p">,</span> <span class="s1">&#39;retry_exceptions&#39;</span><span class="p">,</span> <span class="s1">&#39;allowed_exceptions&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;immediate&#39;</span><span class="p">,</span> <span class="s1">&#39;ddl&#39;</span><span class="p">,</span> <span class="s1">&#39;serializable&#39;</span><span class="p">,</span> <span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="s1">&#39;optimistic&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;sql_debug&#39;</span><span class="p">,</span> <span class="s1">&#39;show_values&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">immediate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ddl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">serializable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">retry_exceptions</span><span class="o">=</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,),</span> <span class="n">allowed_exceptions</span><span class="o">=</span><span class="p">(),</span> <span class="n">sql_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">retry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retry</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;&#39;retry&#39; parameter of db_session must be of integer type. Got: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">retry</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;&#39;retry&#39; parameter of db_session must not be negative. Got: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">retry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ddl</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;ddl&#39; and &#39;retry&#39; parameters of db_session cannot be used together&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">allowed_exceptions</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">retry_exceptions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">allowed_exceptions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">retry_exceptions</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;The same exception </span><span class="si">%s</span><span class="s1"> cannot be specified in both &#39;</span>
                    <span class="s1">&#39;allowed and retry exception lists simultaneously&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">ddl</span> <span class="o">=</span> <span class="n">ddl</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">serializable</span> <span class="o">=</span> <span class="n">serializable</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">immediate</span> <span class="ow">or</span> <span class="n">ddl</span> <span class="ow">or</span> <span class="n">serializable</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">optimistic</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">optimistic</span> <span class="o">=</span> <span class="n">optimistic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">serializable</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">retry_exceptions</span> <span class="o">=</span> <span class="n">retry_exceptions</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">allowed_exceptions</span> <span class="o">=</span> <span class="n">allowed_exceptions</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="o">=</span> <span class="n">sql_debug</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="n">show_values</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">return</span> <span class="n">db_session</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Pass only keyword arguments to db_session or use db_session as decorator&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span> <span class="k">return</span> <span class="n">db_session</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Pass only keyword arguments to db_session or use db_session as decorator&#39;</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">db_session</span><span class="o">.</span><span class="n">_wrap_function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db_session</span><span class="o">.</span><span class="n">_wrap_generator_function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">retry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s2">&quot;@db_session can accept &#39;retry&#39; parameter only when used as decorator and not as context manager&quot;</span><span class="p">)</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">_enter</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_enter</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span>
            <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
        <span class="k">elif</span> <span class="n">db_session</span><span class="o">.</span><span class="n">ddl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">ddl</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
            <span class="s1">&#39;Cannot start ddl transaction inside non-ddl transaction&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">db_session</span><span class="o">.</span><span class="n">serializable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">serializable</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
            <span class="s1">&#39;Cannot start serializable transaction inside non-serializable transaction&#39;</span><span class="p">)</span>
        <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local</span><span class="o">.</span><span class="n">push_debug_state</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span><span class="p">,</span> <span class="n">db_session</span><span class="o">.</span><span class="n">show_values</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local</span><span class="o">.</span><span class="n">pop_debug_state</span><span class="p">()</span>
        <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">assert</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="n">db_session</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">can_commit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">allowed_exceptions</span><span class="p">):</span>
                <span class="n">can_commit</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">allowed_exceptions</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="c1"># exc can be None in Python 2.6 even if exc_type is not None</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">can_commit</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">allowed_exceptions</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="n">rollback_and_reraise</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">can_commit</span><span class="p">:</span>
                <span class="n">commit</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_get_caches</span><span class="p">():</span> <span class="n">cache</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">rollback</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span>  <span class="c1"># if exc_type is not None it will be reraised outside of __exit__</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span>
            <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">local</span><span class="o">.</span><span class="n">user_groups_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">local</span><span class="o">.</span><span class="n">user_roles_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_wrap_function</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">ddl</span> <span class="ow">and</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> cannot be called inside of db_session&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">local</span><span class="o">.</span><span class="n">push_debug_state</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span><span class="p">,</span> <span class="n">db_session</span><span class="o">.</span><span class="n">show_values</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">retry</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">db_session</span><span class="o">.</span><span class="n">_enter</span><span class="p">()</span>
                    <span class="n">exc_type</span> <span class="o">=</span> <span class="n">exc</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">commit</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                        <span class="n">retry_exceptions</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">retry_exceptions</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">retry_exceptions</span><span class="p">):</span>
                            <span class="n">do_retry</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">retry_exceptions</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># exc can be None in Python 2.6</span>
                            <span class="n">do_retry</span> <span class="o">=</span> <span class="n">retry_exceptions</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_retry</span><span class="p">:</span> <span class="k">raise</span>
                    <span class="k">finally</span><span class="p">:</span> <span class="n">db_session</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
                <span class="n">reraise</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span>
                <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">pop_debug_state</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">new_func</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrap_generator_function</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">gen_func</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ddl&#39;</span><span class="p">,</span> <span class="s1">&#39;retry&#39;</span><span class="p">,</span> <span class="s1">&#39;serializable&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;db_session with `</span><span class="si">%s</span><span class="s2">` option cannot be applied to generator function&quot;</span> <span class="o">%</span> <span class="n">option</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exc_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span> <span class="k">if</span> <span class="nb">input</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
                <span class="n">close</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">close</span><span class="p">()</span>
                <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>

            <span class="n">throw_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s1">&#39;throw&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">throw_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">throw_</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">new_gen_func</span><span class="p">(</span><span class="n">gen_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">db2cache_copy</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">def</span> <span class="nf">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
                    <span class="s1">&#39;@db_session-wrapped generator cannot be used inside another db_session&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span>
                <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
                <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">db2cache_copy</span><span class="p">)</span>
                <span class="n">db2cache_copy</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">push_debug_state</span><span class="p">(</span><span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span><span class="p">,</span> <span class="n">db_session</span><span class="o">.</span><span class="n">show_values</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_get_caches</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
                                <span class="s1">&#39;You need to manually commit() changes before exiting from the generator&#39;</span><span class="p">)</span>
                        <span class="k">raise</span>
                    <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_get_caches</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
                            <span class="s1">&#39;You need to manually commit() changes before yielding from the generator&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">rollback_and_reraise</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">output</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">sql_debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">local</span><span class="o">.</span><span class="n">pop_debug_state</span><span class="p">()</span>
                    <span class="n">db2cache_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="p">)</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">gen</span> <span class="o">=</span> <span class="n">gen_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">input</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">output</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">new_gen_func</span><span class="p">,</span> <span class="n">gen_func</span><span class="p">)</span>

<span class="n">db_session</span> <span class="o">=</span> <span class="n">DBSessionContextManager</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SQLDebuggingContextManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_values</span> <span class="o">=</span> <span class="n">show_values</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_function</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_generator_function</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">local</span><span class="o">.</span><span class="n">push_debug_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_values</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">local</span><span class="o">.</span><span class="n">pop_debug_state</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_wrap_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">new_func</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrap_generator_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exc_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span> <span class="k">if</span> <span class="nb">input</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
                <span class="n">close</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">close</span><span class="p">()</span>
                <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>

            <span class="n">throw_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s1">&#39;throw&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">throw_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">throw_</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">new_gen_func</span><span class="p">(</span><span class="n">gen_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>

            <span class="n">gen</span> <span class="o">=</span> <span class="n">gen_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">input</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">output</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">wrapped_interact</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">new_gen_func</span><span class="p">,</span> <span class="n">gen_func</span><span class="p">)</span>

<span class="n">sql_debugging</span> <span class="o">=</span> <span class="n">SQLDebuggingContextManager</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">throw_db_session_is_over</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cannot </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1">: the database session is over&#39;</span>
    <span class="n">throw</span><span class="p">(</span><span class="n">DatabaseSessionIsOver</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">attr</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">with_transaction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">deprecated</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;@with_transaction decorator is deprecated, use @db_session decorator instead&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db_session</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">db_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">web</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pony.web&#39;</span><span class="p">)</span>
    <span class="n">allowed_exceptions</span> <span class="o">=</span> <span class="p">[</span> <span class="n">web</span><span class="o">.</span><span class="n">HttpRedirect</span> <span class="p">]</span> <span class="k">if</span> <span class="n">web</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">db_session</span><span class="p">(</span><span class="n">allowed_exceptions</span><span class="o">=</span><span class="n">allowed_exceptions</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">RowNotFound</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">web</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">Http404NotFound</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="n">known_providers</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;oracle&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">OnConnectDecorator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">provider</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;provider&#39; option should be type of &#39;string&#39;, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provider</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_providers</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">BindingError</span><span class="p">,</span> <span class="s1">&#39;Unknown provider </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">provider</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="n">OnConnectDecorator</span><span class="o">.</span><span class="n">check_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_on_connect_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">provider</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span> <span class="ow">and</span> <span class="n">func</span> <span class="ow">is</span> <span class="n">basestring</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">OnConnectDecorator</span><span class="o">.</span><span class="n">check_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OnConnectDecorator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Database cannot be cloned by deepcopy()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># argument &#39;self&#39; cannot be named &#39;database&#39;, because &#39;database&#39; can be in kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># ER-diagram related stuff:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_translator_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constructed_sql_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Entity</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">EntityMeta</span><span class="p">,</span> <span class="s1">&#39;Entity&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Entity</span><span class="p">,),</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">_database_</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Statistics-related stuff:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_stats_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dblocal</span> <span class="o">=</span> <span class="n">DbLocal</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="n">OnConnectDecorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_connect_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">call_on_connect</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">_on_connect_funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span> <span class="ow">or</span> <span class="n">provider</span> <span class="o">==</span> <span class="n">database</span><span class="o">.</span><span class="n">provider_name</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
                <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># argument &#39;self&#39; cannot be named &#39;database&#39;, because &#39;database&#39; can be in kwargs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">BindingError</span><span class="p">,</span> <span class="s1">&#39;Database object was already bound to </span><span class="si">%s</span><span class="s1"> provider&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="s1">&#39;provider&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Database provider is not specified&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">DBAPIProvider</span><span class="p">):</span>
            <span class="n">provider_cls</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;pygresql&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;Pony no longer supports PyGreSQL module. Please use psycopg2 instead.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">provider_name</span> <span class="o">=</span> <span class="n">provider</span>
            <span class="n">provider_module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;pony.orm.dbproviders.&#39;</span> <span class="o">+</span> <span class="n">provider</span><span class="p">)</span>
            <span class="n">provider_cls</span> <span class="o">=</span> <span class="n">provider_module</span><span class="o">.</span><span class="n">provider_cls</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pony_call_on_connect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_on_connect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider_cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_sql</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span><span class="o">.</span><span class="n">last_sql</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_stats</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span><span class="o">.</span><span class="n">stats</span>
    <span class="k">def</span> <span class="nf">_update_local_stat</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">query_start_time</span><span class="p">):</span>
        <span class="n">dblocal</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span>
        <span class="n">dblocal</span><span class="o">.</span><span class="n">last_sql</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">dblocal</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">query_executed</span><span class="p">(</span><span class="n">query_start_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="n">sql</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueryStat</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">query_start_time</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">merge_local_stats</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">setdefault</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_global_stats</span><span class="o">.</span><span class="n">setdefault</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">_global_stats_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span><span class="o">.</span><span class="n">stats</span><span class="p">):</span>
                <span class="n">global_stat</span> <span class="o">=</span> <span class="n">setdefault</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">global_stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">stat</span><span class="p">:</span> <span class="n">global_stat</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_stats</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">_global_stats_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">sql</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">_global_stats</span><span class="p">)}</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_stats_lock</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">deprecated</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;global_stats_lock is deprecated, just use global_stats property without any locking&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_global_stats_lock</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">assert</span> <span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">connection</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;disconnect() cannot be called inside of db_sesison&#39;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">provider</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_get_cache</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;Database object is not bound with a provider yet&#39;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">db_context_counter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">pony</span><span class="o">.</span><span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;INTERACTIVE&#39;</span> <span class="ow">and</span> <span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">_MainThread</span>
            <span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;db_session is required when working with the database&#39;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="p">[</span><span class="n">database</span><span class="p">]</span> <span class="o">=</span> <span class="n">SessionCache</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">flush_and_commit</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">transact_reraise</span><span class="p">(</span><span class="n">RollbackException</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()])</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_exec_raw_sql</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;Database object is not bound with a provider yet&#39;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[:]</span>  <span class="c1"># sql = templating.plainstr(sql)</span>
        <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">locals</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">frame_depth</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">frame_depth</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span>
            <span class="nb">locals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">frame_depth</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="n">adapted_sql</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">adapt_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">provider</span><span class="o">.</span><span class="n">paramstyle</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">adapted_sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">start_transaction</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">select_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span> <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select &#39;</span> <span class="o">+</span> <span class="n">sql</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">+</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">max_fetch_count</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">MAX_FETCH_COUNT</span>
        <span class="k">if</span> <span class="n">max_fetch_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">max_fetch_count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TooManyRowsFound</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span> <span class="p">]</span>
        <span class="n">row_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,),</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">):</span>
            <span class="n">column_name</span> <span class="o">=</span> <span class="n">column_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ident</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">column_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span> <span class="k">continue</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">row_class</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">row_class</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span> <span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">RowNotFound</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MultipleRowsFound</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">select_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span> <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;select &#39;</span> <span class="o">+</span> <span class="n">sql</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">returning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;Database object is not bound with a provider yet&#39;</span><span class="p">)</span>
        <span class="n">query_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># keys are not sorted deliberately!!</span>
        <span class="k">if</span> <span class="n">returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">query_key</span> <span class="o">=</span> <span class="n">query_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">returning</span><span class="p">,)</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_insert_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span> <span class="p">],</span> <span class="n">returning</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
            <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
            <span class="n">database</span><span class="o">.</span><span class="n">_insert_cache</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">values_list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>  <span class="c1"># order of values same as order of keys</span>
        <span class="k">if</span> <span class="n">returning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">returning_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="s1">&#39;lastrowid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_ast2sql</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql_ast</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
    <span class="k">def</span> <span class="nf">_exec_sql</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returning_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start_transaction</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="n">log_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">new_id</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">returning_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">reconnect</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="n">log_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">returning_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_update_local_stat</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">returning_id</span><span class="p">:</span> <span class="k">return</span> <span class="n">cursor</span>
        <span class="k">if</span> <span class="n">PY2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="ow">is</span> <span class="n">long</span><span class="p">:</span> <span class="n">new_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_id</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">generate_mapping</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_tables</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;Database object is not bound with a provider yet&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">BindingError</span><span class="p">,</span> <span class="s1">&#39;Mapping was already generated&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">dbschema_cls</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_id_&#39;</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_resolve_attr_types_</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_link_reverse_attrs_</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_check_table_options_</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column_names</span><span class="p">):</span>
            <span class="n">column_dict</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">column_dict</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">column_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_get_pk_columns_</span><span class="p">()</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span>

            <span class="n">is_subclass</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span>
            <span class="k">if</span> <span class="n">is_subclass</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span><span class="o">.</span><span class="n">_table_</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="k">elif</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_entity_table_name</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">add_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="c1"># many-to-one:</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                            <span class="s2">&quot;Parameter &#39;table&#39; is not allowed for many-to-one attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span>
                            <span class="s2">&quot;Parameter &#39;column&#39; is not allowed for many-to-one attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># many-to-many:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">&gt;</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="o">&gt;</span> <span class="n">reverse</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
                        <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span> <span class="o">!=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                            <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;table&#39; for </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> do not match&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
                        <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
                    <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_m2m_table_name</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

                    <span class="n">m2m_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m2m_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                            <span class="n">seq_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">while</span> <span class="n">m2m_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                                    <span class="n">new_table_name</span> <span class="o">=</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">seq_counter</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">schema_name</span><span class="p">,</span> <span class="n">base_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">split_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                                    <span class="n">new_table_name</span> <span class="o">=</span> <span class="n">schema_name</span><span class="p">,</span> <span class="n">base_name</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">next</span><span class="p">(</span><span class="n">seq_counter</span><span class="p">)</span>
                                <span class="n">m2m_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_table_name</span><span class="p">)</span>
                            <span class="n">table_name</span> <span class="o">=</span> <span class="n">new_table_name</span>
                        <span class="k">elif</span> <span class="n">m2m_table</span><span class="o">.</span><span class="n">entities</span> <span class="ow">or</span> <span class="n">m2m_table</span><span class="o">.</span><span class="n">m2m</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                            <span class="s2">&quot;Table name </span><span class="si">%s</span><span class="s2"> is already in use&quot;</span> <span class="o">%</span> <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table_name</span>
                    <span class="n">m2m_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                    <span class="n">m2m_columns_1</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_m2m_columns</span><span class="p">(</span><span class="n">is_reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">m2m_columns_2</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">get_m2m_columns</span><span class="p">(</span><span class="n">is_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m2m_columns_1</span> <span class="o">==</span> <span class="n">m2m_columns_2</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                        <span class="s1">&#39;Different column names should be specified for attributes </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">m2m_columns_1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">m2m_columns_2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">m2m_columns_1</span> <span class="o">+</span> <span class="n">m2m_columns_2</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">):</span>
                        <span class="n">m2m_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">converter</span><span class="o">.</span><span class="n">get_sql_type</span><span class="p">(),</span> <span class="n">converter</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">m2m_table</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">m2m_table</span><span class="o">.</span><span class="n">column_list</span><span class="p">),</span> <span class="n">is_pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">m2m_table</span><span class="o">.</span><span class="n">m2m</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">m2m_table</span><span class="o">.</span><span class="n">m2m</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="k">pass</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_string</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Optional attribute with non-string type </span><span class="si">%s</span><span class="s1"> must be nullable&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">dialect</span> <span class="o">==</span> <span class="s1">&#39;Oracle&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                            <span class="s1">&#39;In Oracle, optional string attribute </span><span class="si">%s</span><span class="s1"> must be nullable&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_columns</span><span class="p">()</span>  <span class="c1"># initializes attr.converters</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">default</span><span class="p">):</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">converter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">converter</span><span class="o">.</span><span class="n">get_sql_type</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span>
                                         <span class="n">converter</span><span class="p">,</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">columns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span>
                            <span class="s1">&#39;sql_type cannot be specified for composite attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">):</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">converter</span><span class="o">.</span><span class="n">get_sql_type</span><span class="p">(),</span> <span class="n">converter</span><span class="p">,</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>  <span class="c1"># virtual attribute of one-to-one pair</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_with_columns_</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span>
                                                 <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">pk_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span> <span class="n">is_pk</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">is_pk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">),</span> <span class="n">is_pk</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_indexes_</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span> <span class="n">column_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">column_names</span><span class="p">),</span> <span class="n">is_unique</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">)</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">columns_without_pk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">converters_without_pk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  <span class="c1"># todo: inheritance</span>
                <span class="n">converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span><span class="p">:</span>
                    <span class="n">columns_without_pk</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">converters_without_pk</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_columns_</span> <span class="o">=</span> <span class="n">columns</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_columns_without_pk_</span> <span class="o">=</span> <span class="n">columns_without_pk</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_converters_</span> <span class="o">=</span> <span class="n">converters</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_converters_without_pk_</span> <span class="o">=</span> <span class="n">converters_without_pk</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_table_</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="n">m2m_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">table</span><span class="p">]</span>
                    <span class="n">parent_columns</span> <span class="o">=</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
                    <span class="n">child_columns</span> <span class="o">=</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">m2m_table</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">m2m_table</span><span class="o">.</span><span class="n">add_foreign_key</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">fk_name</span><span class="p">,</span> <span class="n">child_columns</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">parent_columns</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
                        <span class="n">child_columns</span> <span class="o">=</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">m2m_table</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">)</span>
                        <span class="n">m2m_table</span><span class="o">.</span><span class="n">add_foreign_key</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse_fk_name</span><span class="p">,</span> <span class="n">child_columns</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">parent_columns</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">rentity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
                    <span class="n">parent_table</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">rentity</span><span class="o">.</span><span class="n">_table_</span><span class="p">]</span>
                    <span class="n">parent_columns</span> <span class="o">=</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
                    <span class="n">child_columns</span> <span class="o">=</span> <span class="n">get_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">add_foreign_key</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">fk_name</span><span class="p">,</span> <span class="n">child_columns</span><span class="p">,</span> <span class="n">parent_table</span><span class="p">,</span> <span class="n">parent_columns</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">column_dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">is_unique</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_initialize_bits_</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">create_tables</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">create_tables</span><span class="p">(</span><span class="n">check_tables</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">check_tables</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">check_tables</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">(</span><span class="n">ddl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_all_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_drop_tables</span><span class="p">([</span> <span class="n">table_name</span> <span class="p">],</span> <span class="n">if_exists</span><span class="p">,</span> <span class="n">with_all_data</span><span class="p">,</span> <span class="n">try_normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_table_name</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_table_</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s2">&quot;Attribute </span><span class="si">%s</span><span class="s2"> is not Set and doesn&#39;t have corresponding table&quot;</span> <span class="o">%</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;No mapping was generated for the database&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Table name cannot be None&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Invalid table name component: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="p">[:]</span>  <span class="c1"># table_name = templating.plainstr(table_name)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Invalid table name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">table_name</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">(</span><span class="n">ddl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">drop_all_tables</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">with_all_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;No mapping was generated for the database&#39;</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_drop_tables</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">with_all_data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_drop_tables</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">,</span> <span class="n">with_all_data</span><span class="p">,</span> <span class="n">try_normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="n">existed_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span> <span class="n">existed_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">if_exists</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">try_normalized</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                        <span class="n">normalized_table_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">schema_name</span><span class="p">,</span> <span class="n">base_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">split_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                        <span class="n">normalized_table_name</span> <span class="o">=</span> <span class="n">schema_name</span><span class="p">,</span> <span class="n">provider</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">normalized_table_name</span> <span class="o">!=</span> <span class="n">table_name</span> <span class="ow">and</span> <span class="n">provider</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">normalized_table_name</span><span class="p">):</span>
                        <span class="n">throw</span><span class="p">(</span><span class="n">TableDoesNotExist</span><span class="p">,</span> <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1"> does not exist (probably you meant table </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                 <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                                                 <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">normalized_table_name</span><span class="p">)))</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TableDoesNotExist</span><span class="p">,</span> <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_all_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">existed_tables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">table_has_data</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">TableIsNotEmpty</span><span class="p">,</span>
                    <span class="s1">&#39;Cannot drop table </span><span class="si">%s</span><span class="s1"> because it is not empty. Specify option &#39;</span>
                    <span class="s1">&#39;with_all_data=True if you want to drop table with all data&#39;</span>
                    <span class="o">%</span> <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">existed_tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="n">log_orm</span><span class="p">(</span><span class="s1">&#39;DROPPING TABLE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">provider</span><span class="o">.</span><span class="n">format_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">(</span><span class="n">ddl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">check_tables</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;No mapping was generated for the database&#39;</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>
        <span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">create_tables</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_tables</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">check_tables</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">check_tables</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s1">&#39;No mapping was generated for the database&#39;</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>
        <span class="n">database</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">check_tables</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">set_perms_for</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entities</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;You should specify at least one positional argument&#39;</span><span class="p">)</span>
        <span class="n">entity_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Entity class expected. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="p">)</span>
            <span class="n">entity_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_subclasses_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">OrmError</span><span class="p">,</span> <span class="s2">&quot;&#39;set_perms_for&#39; context manager calls cannot be nested&quot;</span><span class="p">)</span>
        <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="o">=</span> <span class="n">database</span><span class="p">,</span> <span class="n">entity_set</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="ow">and</span> <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">database</span>
            <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_get_schema_dict</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_id_&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;lazy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nullable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">default</span><span class="p">),</span> <span class="p">(</span><span class="n">int_types</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)):</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">newAttrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">pkAttrs</span><span class="o">=</span><span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span> <span class="p">])</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_all_bases_</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">base</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_all_bases_</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_simple_keys_</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;simpleKeys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_simple_keys_</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;compositeKeys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="p">]</span> <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_composite_keys_</span> <span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">_get_schema_json</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">schema_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">_get_schema_dict</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="n">basic_converter</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">schema_hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">schema_json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">schema_json</span><span class="p">,</span> <span class="n">schema_hash</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">(),</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">((</span><span class="n">include</span><span class="p">,</span> <span class="s1">&#39;include&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="s1">&#39;exclude&#39;</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s2">&quot;Each item of &#39;</span><span class="si">%s</span><span class="s2">&#39; list should be attribute. Got: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">basic_converter</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">user_has_no_rights_to_see</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">user_groups</span> <span class="o">=</span> <span class="n">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="s1">&#39;The current user </span><span class="si">%s</span><span class="s1"> which belongs to groups </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                   <span class="s1">&#39;has no rights to see the object </span><span class="si">%s</span><span class="s1"> on the frontend&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">user_groups</span><span class="p">),</span> <span class="n">obj</span><span class="p">))</span>

        <span class="n">object_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">caches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">obj_converter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span> <span class="k">return</span> <span class="n">converter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
            <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">caches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
                <span class="s1">&#39;An attempt to serialize objects belonging to different transactions&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="n">user_has_no_rights_to_see</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">object_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">pkval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pkval</span> <span class="p">}</span>

        <span class="n">data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">obj_converter</span><span class="p">)</span>

        <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">caches</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">caches</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;An object does not belong to specified database&#39;</span><span class="p">)</span>
            <span class="n">object_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">object_set</span><span class="p">)</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                    <span class="n">user_has_no_rights_to_see</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">():</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span> <span class="k">pass</span>
                        <span class="c1"># if attr not in entity_perms.can_read: user_has_no_rights_to_see(obj, attr)</span>
                    <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="c1"># elif attr not in entity_perms.can_read: continue</span>

                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                                <span class="n">object_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                                <span class="n">object_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="n">pkval</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
                            <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">pkval</span><span class="p">)</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">include</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                                <span class="n">object_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">object_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="n">pkval</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">pkval</span>

                    <span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">objects_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">converter</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;{&quot;data&quot;: </span><span class="si">%s</span><span class="s1">, &quot;objects&quot;: </span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_json</span><span class="p">,</span> <span class="n">objects_json</span><span class="p">)</span>
        <span class="n">schema_json</span><span class="p">,</span> <span class="n">new_schema_hash</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_schema_json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">schema_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema_hash</span> <span class="o">==</span> <span class="n">new_schema_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;{&quot;data&quot;: </span><span class="si">%s</span><span class="s1">, &quot;objects&quot;: </span><span class="si">%s</span><span class="s1">, &quot;schema_hash&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;}&#39;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">data_json</span><span class="p">,</span> <span class="n">objects_json</span><span class="p">,</span> <span class="n">new_schema_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;{&quot;data&quot;: </span><span class="si">%s</span><span class="s1">, &quot;objects&quot;: </span><span class="si">%s</span><span class="s1">, &quot;schema&quot;: </span><span class="si">%s</span><span class="s1">, &quot;schema_hash&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;}&#39;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="n">data_json</span><span class="p">,</span> <span class="n">objects_json</span><span class="p">,</span> <span class="n">schema_json</span><span class="p">,</span> <span class="n">new_schema_hash</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pprint</span><span class="p">;</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="n">objmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_status_&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_pk_&#39;</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="p">(</span><span class="n">pk</span><span class="p">,)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
            <span class="n">entity_name</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_id_&#39;</span><span class="p">]</span>
            <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">def</span> <span class="nf">id2obj</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">objmap</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">get_current_user</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">user_has_no_rights_to</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">user_groups</span> <span class="o">=</span> <span class="n">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;object </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="s1">&#39;The current user </span><span class="si">%s</span><span class="s1"> which belongs to groups </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                   <span class="s1">&#39;has no rights to </span><span class="si">%s</span><span class="s1"> the </span><span class="si">%s</span><span class="s1"> on the frontend&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">user_groups</span><span class="p">),</span> <span class="n">operation</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
            <span class="n">entity_name</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span>
            <span class="n">oldvals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">newvals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">oldadict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">newadict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;_pk_&#39;</span><span class="p">,</span> <span class="s1">&#39;_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;_status_&#39;</span><span class="p">):</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;old&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span> <span class="n">oldvals</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldadict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">id2obj</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="s1">&#39;new&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span> <span class="n">newvals</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newadict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">id2obj</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">newvals</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newadict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">id2obj</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_id_&#39;</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_status_&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">oldvals</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">newadict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_create</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="p">(</span><span class="o">**</span><span class="n">newvals</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">observer</span><span class="p">:</span>
                    <span class="n">flush</span><span class="p">()</span>  <span class="c1"># in order to get obj.id</span>
                    <span class="n">observer</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">newvals</span><span class="p">)</span>
                <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">can_edit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_delete</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">observer</span><span class="p">:</span> <span class="n">observer</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_edit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">newvals</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">newadict</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">can_edit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">oldvals</span>
                        <span class="k">if</span> <span class="n">observer</span><span class="p">:</span>
                            <span class="n">observer</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">newvals</span><span class="p">,</span> <span class="n">oldvals</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_db_set_</span><span class="p">(</span><span class="n">oldadict</span><span class="p">)</span>  <span class="c1"># oldadict can be modified here</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">oldadict</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">newvals</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="ow">not</span> <span class="n">oldvals</span>
                    <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">flush</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_status_&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">objmap</span><span class="p">[</span><span class="n">diff</span><span class="p">[</span><span class="s1">&#39;_id_&#39;</span><span class="p">]]</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;_pk_&#39;</span><span class="p">,</span> <span class="s1">&#39;_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;_status_&#39;</span><span class="p">):</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="n">attr</span> <span class="o">&lt;</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                        <span class="n">removed</span> <span class="o">=</span> <span class="p">[</span> <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="p">())</span> <span class="p">]</span>
                        <span class="n">added</span> <span class="o">=</span> <span class="p">[</span> <span class="n">objmap</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="p">())</span> <span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">added</span> <span class="ow">or</span> <span class="n">removed</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">can_edit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span> <span class="n">user_has_no_rights_to</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="n">collection</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                            <span class="n">observer</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">removed</span><span class="p">})</span>
                            <span class="n">collection</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                            <span class="n">observer</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">added</span><span class="p">})</span>
                            <span class="n">collection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
        <span class="n">flush</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">deserialize</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;_id_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">objmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;_id_&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">entity_name</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
                    <span class="n">entity</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span>
                    <span class="n">pk</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;_pk_&#39;</span><span class="p">]</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">basic_converter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
        <span class="n">pkval</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">pkval</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;The following object cannot be converted to JSON: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">perm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">throw</span><span class="p">(</span><span class="n">OrmError</span><span class="p">,</span> <span class="s2">&quot;&#39;perm&#39; function can be called within &#39;set_perm_for&#39; context manager only&quot;</span><span class="p">)</span>
    <span class="n">database</span><span class="p">,</span> <span class="n">entities</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">perms_context</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="n">_split_names</span><span class="p">(</span><span class="s1">&#39;Permission&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">pop_names_from_kwargs</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">pop_names_from_kwargs</span><span class="p">(</span><span class="s1">&#39;Role&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pop_names_from_kwargs</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kwname</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Unknown keyword argument name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kwname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AccessRule</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_split_names</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">namelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> name should be string. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_split_names</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ident</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> name should be identifier. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pop_names_from_kwargs</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">kwname</span> <span class="ow">in</span> <span class="n">kwnames</span><span class="p">:</span>
        <span class="n">kwarg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">kwname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_split_names</span><span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">AccessRule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="n">entities</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;At least one permission should be specified&#39;</span><span class="p">)</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">permissions</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;anybody&#39;</span><span class="p">)</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">roles</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">attrs_to_exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">permissions</span><span class="p">:</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_access_rules_</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exclude</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_subclasses_</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Primary key attribute </span><span class="si">%s</span><span class="s1"> cannot be excluded&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">attrs_to_exclude</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Entity or attribute expected. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">hidden</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">entity</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;The third parameter of &#39;has_perm&#39; function should be entity class, entity instance &quot;</span>
                           <span class="s2">&quot;or attribute. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">access_rules</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_access_rules_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_rules</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
    <span class="n">perm_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">perm_cache</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">perm</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">perm_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
    <span class="n">user_groups</span> <span class="o">=</span> <span class="n">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">access_rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_groups</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">access_rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_groups</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span> \
                                                   <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">attrs_to_exclude</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">reverse_rules</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_access_rules_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse_rules</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">reverse_rule</span> <span class="ow">in</span> <span class="n">access_rules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">user_groups</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">reverse_rule</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reverse_rule</span><span class="o">.</span><span class="n">entities_to_exclude</span> \
                            <span class="ow">and</span> <span class="n">reverse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reverse_rule</span><span class="o">.</span><span class="n">attrs_to_exclude</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">user_roles</span> <span class="o">=</span> <span class="n">get_user_roles</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">obj_labels</span> <span class="o">=</span> <span class="n">get_object_labels</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">access_rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">entities_to_exclude</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">user_groups</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">groups</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">user_roles</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">roles</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">obj_labels</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span> <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="n">perm_cache</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">can_view</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_edit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_create</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_delete</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_current_user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">local</span><span class="o">.</span><span class="n">current_user</span>

<span class="k">def</span> <span class="nf">set_current_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">local</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>

<span class="n">anybody_frozenset</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;anybody&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">user_groups_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">anybody_frozenset</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anybody&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">usergroup_functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># single group name</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">local</span><span class="o">.</span><span class="n">user_groups_cache</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_user_roles</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="nb">frozenset</span><span class="p">()</span>
    <span class="n">roles_cache</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">user_roles_cache</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">roles_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user_cls</span><span class="p">,</span> <span class="n">obj_cls</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">userrole_functions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">user_cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_cls</span><span class="p">):</span>
                <span class="n">roles</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roles</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># single role name</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">roles</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">roles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">roles</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">roles_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_object_labels</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
    <span class="n">obj_labels_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">obj_labels_cache</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">obj_labels_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj_cls</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">objlabel_functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_cls</span><span class="p">):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>  <span class="c1"># single label name</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">obj_labels_cache</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">usergroup_functions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">user_groups_getter</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usergroup_functions</span><span class="p">:</span>
            <span class="n">usergroup_functions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="n">userrole_functions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">user_roles_getter</span><span class="p">(</span><span class="n">user_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">userrole_functions</span><span class="p">:</span>
            <span class="n">userrole_functions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_cls</span><span class="p">,</span> <span class="n">obj_cls</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="n">objlabel_functions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">obj_labels_getter</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">objlabel_functions</span><span class="p">:</span>
            <span class="n">objlabel_functions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="k">class</span> <span class="nc">DbLocal</span><span class="p">(</span><span class="n">localbase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">dblocal</span><span class="p">):</span>
        <span class="n">dblocal</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dblocal</span><span class="o">.</span><span class="n">last_sql</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">QueryStat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">query_start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">query_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">query_end_time</span> <span class="o">-</span> <span class="n">query_start_time</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">=</span> <span class="n">duration</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">cache_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">cache_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">stat</span><span class="o">.</span><span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">stat</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">QueryStat</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">query_executed</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">query_start_time</span><span class="p">):</span>
        <span class="n">query_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">query_end_time</span> <span class="o">-</span> <span class="n">query_start_time</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span><span class="p">:</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">min_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">+=</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">stat2</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">stat</span><span class="o">.</span><span class="n">sql</span> <span class="o">==</span> <span class="n">stat2</span><span class="o">.</span><span class="n">sql</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stat2</span><span class="o">.</span><span class="n">db_count</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span><span class="p">:</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">min_time</span><span class="p">,</span> <span class="n">stat2</span><span class="o">.</span><span class="n">min_time</span><span class="p">)</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span> <span class="n">stat2</span><span class="o">.</span><span class="n">max_time</span><span class="p">)</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">+=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">sum_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">min_time</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">max_time</span>
            <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">sum_time</span>
        <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span> <span class="o">+=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">db_count</span>
        <span class="n">stat</span><span class="o">.</span><span class="n">cache_count</span> <span class="o">+=</span> <span class="n">stat2</span><span class="o">.</span><span class="n">cache_count</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">avg_time</span><span class="p">(</span><span class="n">stat</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">stat</span><span class="o">.</span><span class="n">sum_time</span> <span class="o">/</span> <span class="n">stat</span><span class="o">.</span><span class="n">db_count</span>

<span class="n">num_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SessionCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">num_counter</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">collection_statistics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">db_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">db_session</span><span class="o">.</span><span class="n">immediate</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">saved_fk_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">perm_cache</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>  <span class="c1"># user -&gt; perm -&gt; cls_or_attr_or_obj -&gt; bool</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">user_roles_cache</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># user -&gt; obj -&gt; roles</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">obj_labels_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># obj -&gt; labels</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ConnectionClosedError</span><span class="p">,</span>
            <span class="s1">&#39;Transaction cannot be continued because database connection failed&#39;</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">database</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">is_new_connection</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_new_connection</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">call_on_connect</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">set_transaction_mode</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>  <span class="c1"># can set cache.in_transaction</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="k">return</span> <span class="n">connection</span>
    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;original_exc&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="o">.</span><span class="n">should_reconnect</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span> <span class="n">reraise</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">local</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="n">log_orm</span><span class="p">(</span><span class="s1">&#39;CONNECTION FAILED: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span>
            <span class="k">assert</span> <span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">prepare_connection_for_query_execution</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">db_session</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span>
        <span class="k">if</span> <span class="n">db_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This situation can arise when a transaction was started</span>
            <span class="c1"># in the interactive mode, outside of the db_session</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
                <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_and_commit</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="ow">or</span> <span class="n">db_session</span><span class="o">.</span><span class="n">immediate</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="n">db_session</span><span class="p">,</span> <span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">db_session</span><span class="p">,</span> <span class="n">db_session</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">provider</span><span class="o">.</span><span class="n">set_transaction_mode</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>  <span class="c1"># can set cache.in_transaction</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">reconnect</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connection</span>
    <span class="k">def</span> <span class="nf">flush_and_commit</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">transact_reraise</span><span class="p">(</span><span class="n">CommitException</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()])</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">rollback</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">rollback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">rollback</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollback</span><span class="p">:</span> <span class="k">assert</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">database</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">db2cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">database</span><span class="p">);</span> <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="n">cache</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rollback</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">provider</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">provider</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="n">provider</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">or</span> <span class="n">local</span><span class="o">.</span><span class="n">db_session</span>
            <span class="k">if</span> <span class="n">db_session</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db_session</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">perm_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">user_roles_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">obj_labels_cache</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">setdata</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cache</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span> \
                <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span> \
                <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">collection_statistics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">flush_disabled</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="k">return</span>

            <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span><span class="p">:</span>  <span class="c1"># can grow during iteration</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_before_save_</span><span class="p">()</span>

                <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">modified_m2m</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">_calc_modified_m2m</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">modified_m2m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">removed</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">remove_m2m</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">modified_m2m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">added</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">add_m2m</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>

            <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">cache</span><span class="o">.</span><span class="n">call_after_save_hooks</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
                <span class="s1">&#39;Recursion depth limit reached in obj._after_save_() call&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">call_after_save_hooks</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">saved_objects</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">saved_objects</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_after_save_</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_calc_modified_m2m</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
        <span class="n">modified_m2m</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">),</span>
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
                    <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reverse</span> <span class="ow">in</span> <span class="n">modified_m2m</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">added</span><span class="p">,</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">modified_m2m</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
                <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">:</span> <span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span> <span class="n">removed</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">:</span> <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">modified_m2m</span>
    <span class="k">def</span> <span class="nf">update_simple_index</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">old_val</span> <span class="o">!=</span> <span class="n">new_val</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">CacheIndexError</span><span class="p">,</span> <span class="s1">&#39;Cannot update </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> with key </span><span class="si">%s</span><span class="s1"> already exists&#39;</span>
                                                 <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">new_val</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">old_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">del</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">old_val</span><span class="p">]</span>
        <span class="n">undo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">db_update_simple_index</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">old_dbval</span> <span class="o">!=</span> <span class="n">new_dbval</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_dbval</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionIntegrityError</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> with unique index </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> already exists: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">obj2</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">))</span>
                <span class="c1"># attribute which was created or updated lately clashes with one stored in database</span>
        <span class="n">cache_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_composite_index</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">undo</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">prev_vals</span> <span class="o">!=</span> <span class="n">new_vals</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">prev_vals</span><span class="p">:</span> <span class="n">prev_vals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">:</span> <span class="n">new_vals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">prev_vals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_vals</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">attr_names</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">CacheIndexError</span><span class="p">,</span> <span class="s1">&#39;Cannot update </span><span class="si">%r</span><span class="s1">: composite key (</span><span class="si">%s</span><span class="s1">) with value </span><span class="si">%s</span><span class="s1"> already exists for </span><span class="si">%r</span><span class="s1">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_names</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">obj2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">prev_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">del</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">prev_vals</span><span class="p">]</span>
        <span class="n">undo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">db_update_composite_index</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">prev_vals</span> <span class="o">!=</span> <span class="n">new_vals</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">:</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_vals</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">key_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">)</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TransactionIntegrityError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> with unique index (</span><span class="si">%s</span><span class="s1">) already exists: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">obj2</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">),</span> <span class="n">key_str</span><span class="p">))</span>
        <span class="n">cache_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">prev_vals</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NotLoadedValueType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;NOT_LOADED&#39;</span>

<span class="n">NOT_LOADED</span> <span class="o">=</span> <span class="n">NotLoadedValueType</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DefaultValueType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;DEFAULT&#39;</span>

<span class="n">DEFAULT</span> <span class="o">=</span> <span class="n">DefaultValueType</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DescWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;DescWrapper(</span><span class="si">%s</span><span class="s1">)&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DescWrapper</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">attr</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DescWrapper</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">attr</span>
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">attr_id_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Attribute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="s1">&#39;is_required&#39;</span><span class="p">,</span> <span class="s1">&#39;is_discriminator&#39;</span><span class="p">,</span> <span class="s1">&#39;is_unique&#39;</span><span class="p">,</span> <span class="s1">&#39;is_part_of_unique_index&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;is_pk&#39;</span><span class="p">,</span> <span class="s1">&#39;is_collection&#39;</span><span class="p">,</span> <span class="s1">&#39;is_relation&#39;</span><span class="p">,</span> <span class="s1">&#39;is_basic&#39;</span><span class="p">,</span> <span class="s1">&#39;is_string&#39;</span><span class="p">,</span> <span class="s1">&#39;is_volatile&#39;</span><span class="p">,</span> <span class="s1">&#39;is_implicit&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;pk_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;pk_columns_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;py_type&#39;</span><span class="p">,</span> <span class="s1">&#39;sql_type&#39;</span><span class="p">,</span> <span class="s1">&#39;entity&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;lazy&#39;</span><span class="p">,</span> <span class="s1">&#39;lazy_sql_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="s1">&#39;composite_keys&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="s1">&#39;col_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;_columns_checked&#39;</span><span class="p">,</span> <span class="s1">&#39;converters&#39;</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;cascade_delete&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;original_default&#39;</span><span class="p">,</span> <span class="s1">&#39;sql_default&#39;</span><span class="p">,</span> <span class="s1">&#39;py_check&#39;</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;optimistic&#39;</span><span class="p">,</span> <span class="s1">&#39;fk_name&#39;</span>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span>  <span class="c1"># Attribute cannot be cloned by deepcopy()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">py_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Attribute</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;Attribute&#39; is abstract type&quot;</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_implicit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Required</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_discriminator</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Discriminator</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;unique&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PrimaryKey</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;unique&#39; option cannot be set for PrimaryKey attribute &quot;</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nullable&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span>  <span class="c1"># Also can be set to True later</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PrimaryKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">attr_id_counter</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">py_type</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;datetime is the module and cannot be used as attribute type. Use datetime.datetime instead&#39;</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Incorrect type of attribute: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">py_type</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="o">=</span> <span class="n">py_type</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_string</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Collection</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="p">(</span><span class="n">EntityMeta</span><span class="p">,</span> <span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">))</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_basic</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">sql_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sql_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">auto</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cascade_delete&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">)):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Value of &#39;reverse&#39; option must be name of reverse attribute). Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Reverse option cannot be set for this type: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">)</span>

        <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameters &#39;column&#39; and &#39;columns&#39; cannot be specified simultaneously&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;column&#39; must be a string. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;columns&#39; must be a list. Got: </span><span class="si">%r</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Items of parameter &#39;columns&#39; must be strings. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">fk_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fk_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">col_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lazy&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="s1">&#39;lazy&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">lazy_sql_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">optimistic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;optimistic&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sql_default&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">py_check</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;py_check&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_init_</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Primary key attribute </span><span class="si">%s</span><span class="s1"> cannot be lazy&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_basic</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;cascade_delete&#39; option cannot be set for attribute </span><span class="si">%s</span><span class="s2">, &quot;</span>
                             <span class="s2">&quot;because it is not relationship attribute&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Optional unique attribute </span><span class="si">%s</span><span class="s1"> must be nullable&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> must be nullable due to single-table inheritance&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">original_default</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Default value for required attribute </span><span class="si">%s</span><span class="s1"> cannot be None&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Default value for required attribute </span><span class="si">%s</span><span class="s1"> cannot be empty string&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;Default value for non-nullable attribute </span><span class="si">%s</span><span class="s1"> cannot be set to None&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_string</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sql_default</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sql_default</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sql_default</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;&#39;sql_default&#39; option value cannot be empty string, &quot;</span>
                <span class="s2">&quot;because it should be valid SQL literal or expression. &quot;</span>
                <span class="s2">&quot;Try to use </span><span class="se">\&quot;</span><span class="s2">&#39;&#39;</span><span class="se">\&quot;</span><span class="s2">, or just specify default=&#39;&#39; instead.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;sql_default&#39; option of </span><span class="si">%s</span><span class="s2"> attribute must be of string or bool type. Got: </span><span class="si">%s</span><span class="s2">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_check</span><span class="p">):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;py_check&#39; parameter of </span><span class="si">%s</span><span class="s2"> attribute should be callable&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

        <span class="c1"># composite keys will be checked later inside EntityMeta.__init__</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;PrimaryKey attribute </span><span class="si">%s</span><span class="s1"> cannot be of type float&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Unique attribute </span><span class="si">%s</span><span class="s1"> cannot be of type float&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span> <span class="ow">and</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> attribute </span><span class="si">%s</span><span class="s1"> cannot be volatile&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">linked</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span>
        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;&#39;cascade_delete&#39; option cannot be set for both sides of relationship &quot;</span>
                <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">) simultaneously&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;&#39;cascade_delete&#39; option cannot be set for attribute </span><span class="si">%s</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;because reverse attribute </span><span class="si">%s</span><span class="s2"> is collection&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">fk_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;You should specify fk_name in </span><span class="si">%s</span><span class="s1"> instead of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> has unknown option </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">option</span><span class="p">))</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="n">owner_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">owner_name</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">from_db</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span>
                <span class="c1"># for required attribute the exception will be thrown later with another message</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> cannot be set to None&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">default</span><span class="p">):</span> <span class="n">val</span> <span class="o">=</span> <span class="n">default</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>

        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>

        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> must be of </span><span class="si">%s</span><span class="s1"> type. Got: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">from_db</span><span class="p">:</span> <span class="k">return</span> <span class="n">converter</span><span class="o">.</span><span class="n">sql2py</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Value for attribute </span><span class="si">%s</span><span class="s1"> cannot be converted to </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                      <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">unicode</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">truncate_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rentity</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rentity</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">val</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="k">else</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rentity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Invalid number of columns were specified for attribute </span><span class="si">%s</span><span class="s1">. Expected: </span><span class="si">%d</span><span class="s1">, got: </span><span class="si">%d</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rentity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="n">from_db</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> must be of </span><span class="si">%s</span><span class="s1"> type. Got: </span><span class="si">%r</span><span class="s1">&#39;</span>
                                                   <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">rentity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">_session_cache_</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;An attempt to mix objects belonging to different transactions&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_check</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Check for attribute </span><span class="si">%s</span><span class="s1"> failed. Value: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">truncate_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">def</span> <span class="nf">parse_value</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">offsets</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">row</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">offsets</span> <span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;load attribute&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">assert</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">dbval</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_find_in_db_</span><span class="p">({</span><span class="n">reverse</span> <span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">dbval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">dbval</span>
            <span class="k">return</span> <span class="n">dbval</span>

        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy_sql_cache</span><span class="p">:</span>
                <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
                <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]</span> <span class="p">]</span>
                <span class="n">pk_columns</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span>
                <span class="n">pk_converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>
                <span class="n">criteria_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">]</span>
                                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">,</span> <span class="n">pk_converters</span><span class="p">))</span> <span class="p">]</span>
                <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="n">criteria_list</span> <span class="p">]</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">lazy_sql_cache</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">offsets</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy_sql_cache</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">dbval</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">db_set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dbval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
        <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wbits</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">|=</span> <span class="n">bit</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">):</span>
            <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span>
        <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">_subclasses_</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">):</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
            <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]:</span>
                <span class="n">val</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;assign new value to&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pkval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span>
            <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_val</span> <span class="o">==</span> <span class="n">pkval</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span><span class="p">]:</span> <span class="k">return</span>
            <span class="k">elif</span> <span class="n">new_val</span> <span class="o">==</span> <span class="n">pkval</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Cannot change value of primary key&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">old_val</span> <span class="o">=</span>  <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_val</span> <span class="ow">is</span> <span class="n">NOT_LOADED</span> <span class="ow">and</span> <span class="n">reverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="n">old_val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
            <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
            <span class="n">objects_to_save_needs_undo</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bit</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="n">wbits</span> <span class="o">|</span> <span class="n">bit</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                    <span class="n">objects_to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="n">objects_to_save_needs_undo</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
                <span class="k">return</span>
            <span class="n">is_reverse_call</span> <span class="o">=</span> <span class="n">undo_funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span> <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">undo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">undo_func</span><span class="p">():</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="n">wbits</span>
                <span class="k">if</span> <span class="n">objects_to_save_needs_undo</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">objects_to_save</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">objects_to_save</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">old_val</span> <span class="ow">is</span> <span class="n">NOT_LOADED</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_val</span>
                <span class="k">for</span> <span class="n">cache_index</span><span class="p">,</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">undo</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">del</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">old_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">old_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">undo_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">undo_func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_val</span> <span class="o">==</span> <span class="n">new_val</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">update_simple_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo</span><span class="p">)</span>
                <span class="n">get_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span>
                <span class="k">for</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">get_val</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="p">]</span>  <span class="c1"># In Python 2 var name leaks into the function scope!</span>
                    <span class="n">prev_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">update_composite_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">undo</span><span class="p">)</span>

                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">old_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ConstraintError</span><span class="p">,</span>
                                <span class="s1">&#39;Cannot unlink </span><span class="si">%r</span><span class="s1"> from previous </span><span class="si">%s</span><span class="s1"> object, because </span><span class="si">%r</span><span class="s1"> attribute is required&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">old_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
                            <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">old_val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
                        <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_remove</span><span class="p">((</span><span class="n">old_val</span><span class="p">,),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
    <span class="k">def</span> <span class="nf">db_set</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">,</span> <span class="n">is_reverse_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">assert</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_or_deleted_statuses</span>
        <span class="k">assert</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="n">NOT_LOADED</span><span class="p">:</span> <span class="k">assert</span> <span class="n">is_reverse_call</span>
        <span class="n">old_dbval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_dbval</span> <span class="o">==</span> <span class="n">new_dbval</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dbvals_equal</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)):</span>
                <span class="k">return</span>

        <span class="n">bit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">old_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Value of </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> was updated outside of current transaction&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (was: </span><span class="si">%s</span><span class="s1">, now: </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Optional</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">old_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Multiple </span><span class="si">%s</span><span class="s2"> objects linked with the same </span><span class="si">%s</span><span class="s2"> object. &quot;</span> \
                      <span class="s2">&quot;Maybe </span><span class="si">%s</span><span class="s2"> attribute should be Set instead of Optional&quot;</span> \
                      <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="n">NOT_LOADED</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dbval</span>

        <span class="n">wbit</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wbit</span><span class="p">:</span>
            <span class="n">old_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">old_val</span> <span class="o">==</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="p">(</span><span class="n">old_val</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_update_simple_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)</span>
                <span class="n">get_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span>
                <span class="k">for</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">get_val</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="p">]</span>  <span class="c1"># In Python 2 var name leaks into the function scope!</span>
                    <span class="n">old_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dbval</span>
                    <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">db_update_composite_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">old_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="n">NOT_LOADED</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dbval</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dbval2val</span><span class="p">(</span><span class="n">new_dbval</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_dbval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">db_set</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">,</span> <span class="n">is_reverse_call</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
                <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_remove</span><span class="p">((</span><span class="n">old_dbval</span><span class="p">,),</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_reverse</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span> <span class="n">old_val</span><span class="o">.</span><span class="n">_delete_</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ConstraintError</span><span class="p">,</span>
                    <span class="s1">&#39;Cannot unlink </span><span class="si">%r</span><span class="s1"> from previous </span><span class="si">%s</span><span class="s1"> object, because </span><span class="si">%r</span><span class="s1"> attribute is required&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">old_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">old_val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span> <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_remove</span><span class="p">((</span><span class="n">old_val</span><span class="p">,),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_add</span><span class="p">((</span><span class="n">new_val</span><span class="p">,),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">db_update_reverse</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_dbval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span> <span class="n">reverse</span><span class="o">.</span><span class="n">db_set</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">db_set</span><span class="p">(</span><span class="n">new_dbval</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old_dbval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">):</span> <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_remove</span><span class="p">((</span><span class="n">old_dbval</span><span class="p">,),</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_add</span><span class="p">((</span><span class="n">new_dbval</span><span class="p">,),</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_raw_values</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span>
        <span class="n">rentity</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_pk_nones_</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>

        <span class="n">provider</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">provider</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="c1"># attr is not part of relationship</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_column_names</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s2">&quot;Too many columns were specified for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">col_paths</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="p">[</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_converter_by_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">generate_columns</span><span class="p">():</span>
                <span class="n">reverse_pk_columns</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_get_pk_columns_</span><span class="p">()</span>
                <span class="n">reverse_pk_col_paths</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_paths_</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_column_names</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">reverse_pk_columns</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reverse_pk_columns</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                    <span class="s1">&#39;Invalid number of columns specified for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">col_paths</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">paths</span><span class="p">))</span> <span class="k">for</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">reverse_pk_col_paths</span> <span class="p">]</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">:</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="c1"># one-to-many:</span>
                <span class="n">generate_columns</span><span class="p">()</span>
            <span class="c1"># one-to-one:</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span>
                <span class="n">generate_columns</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">generate_columns</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">&gt;</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">generate_columns</span><span class="p">()</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">asc</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attr</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DescWrapper</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;auto=True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PrimaryKey</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unique=True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;default=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Optional</span><span class="p">(</span><span class="n">Attribute</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Required</span><span class="p">(</span><span class="n">Attribute</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">Attribute</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">auto</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">sql_default</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_db</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> is required&#39;</span> <span class="o">%</span> <span class="p">(</span>
                      <span class="n">attr</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Database contains </span><span class="si">%s</span><span class="s1"> for required attribute </span><span class="si">%s</span><span class="s1">&#39;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;NULL&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;empty string&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span>
                              <span class="n">DatabaseContainsIncorrectEmptyValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

<span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">Required</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;code2cls&#39;</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">py_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Attribute</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">py_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">code2cls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">_init_</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
            <span class="s1">&#39;Discriminator attribute </span><span class="si">%s</span><span class="s1"> cannot be declared in subclass&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">Required</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span> <span class="o">=</span> <span class="n">attr</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_default_attr</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;classtype&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
            <span class="s2">&quot;Cannot create discriminator column for </span><span class="si">%s</span><span class="s2"> automatically &quot;</span>
            <span class="s2">&quot;because name &#39;classtype&#39; is already in use&quot;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;classtype&#39;</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">is_implicit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;classtype&#39;</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">[</span><span class="s1">&#39;classtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">classtype</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">process_entity_inheritance</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_entity_inheritance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;_discriminator_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">discr_value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span>
        <span class="k">if</span> <span class="n">discr_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="o">=</span> <span class="n">discr_value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">discr_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s2">&quot;Incorrect discriminator value is set for </span><span class="si">%s</span><span class="s2"> attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; of &#39;</span><span class="si">%s</span><span class="s2">&#39; type: </span><span class="si">%r</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">discr_value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">discr_value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Discriminator value for entity </span><span class="si">%s</span><span class="s2"> &quot;</span>
                               <span class="s2">&quot;with custom discriminator column &#39;</span><span class="si">%s</span><span class="s2">&#39; of &#39;</span><span class="si">%s</span><span class="s2">&#39; type is not set&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">code2cls</span><span class="p">[</span><span class="n">discr_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">from_db</span><span class="p">:</span> <span class="k">return</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span>
        <span class="k">return</span> <span class="n">Attribute</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_discriminator_</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
        <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Cannot assign value to discriminator attribute&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">db_set</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">update_reverse</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>

<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;entity&#39;</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">,</span> <span class="s1">&#39;is_pk&#39;</span><span class="p">,</span> <span class="s1">&#39;is_unique&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">index</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;is_pk&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;is_unique&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">options</span>
    <span class="k">def</span> <span class="nf">_init_</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span>
                    <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> does not have attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="n">index</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="s1">&#39;PrimaryKey&#39;</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="k">else</span> <span class="s1">&#39;composite_key&#39;</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="k">else</span> <span class="s1">&#39;composite_index&#39;</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">() arguments must be attributes. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attrs</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s1">&#39;Invalid use of attribute </span><span class="si">%s</span><span class="s1"> in entity </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">key_type</span> <span class="o">=</span> <span class="s1">&#39;primary key&#39;</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="k">else</span> <span class="s1">&#39;unique index&#39;</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="k">else</span> <span class="s1">&#39;index&#39;</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">or</span> <span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">auto</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> attribute </span><span class="si">%s</span><span class="s1"> cannot be part of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> of type float cannot be part of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">key_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Volatile attribute </span><span class="si">%s</span><span class="s1"> cannot be part of primary key&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Optional attribute </span><span class="si">%s</span><span class="s1"> must be nullable, because it is part of composite key&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_string</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;original_default&#39;</span><span class="p">):</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">_define_index</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">is_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">() must receive at least two attributes as arguments&#39;</span> <span class="o">%</span> <span class="n">func_name</span><span class="p">)</span>
    <span class="n">cls_dict</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_indexes_&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Index</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="n">is_pk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_unique</span><span class="o">=</span><span class="n">is_unique</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">composite_index</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">):</span>
    <span class="n">_define_index</span><span class="p">(</span><span class="s1">&#39;composite_index&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">composite_key</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">):</span>
    <span class="n">_define_index</span><span class="p">(</span><span class="s1">&#39;composite_key&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">is_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PrimaryKey</span><span class="p">(</span><span class="n">Required</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;PrimaryKey must receive at least one positional argument&#39;</span><span class="p">)</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">))</span>
        <span class="n">non_attrs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Required</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">non_attrs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;PrimaryKey got invalid arguments: </span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="s1">&#39;something&#39;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">cls_dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">attr</span><span class="p">:</span> <span class="n">attr_name</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span> <span class="k">break</span>
            <span class="n">py_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span> <span class="k">else</span> <span class="nb">repr</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Just use </span><span class="si">%s</span><span class="s1"> = PrimaryKey(</span><span class="si">%s</span><span class="s1">, ...) directly instead of PrimaryKey(</span><span class="si">%s</span><span class="s1">)&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">type_str</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attrs</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_indexes_&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Index</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="n">is_pk</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">Attribute</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;wrapper_class&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetric&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse_column&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse_columns&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;nplus1_threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;cached_load_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;cached_add_m2m_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;cached_remove_m2m_sql&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;cached_count_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;cached_empty_sql&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse_fk_name&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">py_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Collection</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;Collection&#39; is abstract type&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># TODO: rename table to link_table or m2m_table</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;table&#39; must be a string. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name_part</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Each part of table name must be a string. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name_part</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">Attribute</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">py_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;&#39;auto&#39; option could not be set for collection attribute&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">kwargs</span>

        <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse_column&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="o">!=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span> <span class="p">]:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameters &#39;reverse_column&#39; and &#39;reverse_columns&#39; cannot be specified simultaneously&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;reverse_column&#39; must be a string. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;reverse_columns&#39; must be a list. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reverse_column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse_column</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;reverse_columns&#39; must be a list of strings. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">attr</span><span class="o">.</span><span class="n">reverse_fk_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse_fk_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">attr</span><span class="o">.</span><span class="n">nplus1_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nplus1_threshold&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cached_load_sql</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cached_add_m2m_sql</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cached_remove_m2m_sql</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cached_count_sql</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">cached_empty_sql</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_init_</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">Attribute</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s2">&quot;&#39;unique&#39; option cannot be set for attribute </span><span class="si">%s</span><span class="s2"> because it is collection&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Default value could not be set for collection attribute&#39;</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="o">==</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s2">&quot;&#39;reverse_column&#39; and &#39;reverse_columns&#39; options can be set for symmetric relations only&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s2">&quot;&#39;py_check&#39; parameter is not supported for collection attributes&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">fromdb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">fromdb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Abstract method&#39;</span>  <span class="c1"># pragma: no cover</span>

<span class="k">class</span> <span class="nc">SetData</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;is_fully_loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="s1">&#39;absent&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">setdata</span><span class="p">):</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">construct_batchload_criteria_list</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">row_value_syntax</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_seeds</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">param</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">converter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">from_seeds</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">[</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="n">param</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="p">]</span>
                 <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">))</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">param</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="n">param_list</span> <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">condition</span> <span class="p">]</span>
    <span class="k">elif</span> <span class="n">row_value_syntax</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ROW&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span> <span class="p">]</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;ROW&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">param</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">start</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span> <span class="p">]</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">param_list</span> <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">condition</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;AND&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="p">[</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="n">param</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">start</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="p">]</span>
                                     <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">))</span> <span class="p">]</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;OR&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="n">conditions</span> <span class="p">]</span>

<span class="k">class</span> <span class="nc">Set</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">DEFAULT</span><span class="p">:</span> <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;A single </span><span class="si">%(cls)s</span><span class="s1"> instance or </span><span class="si">%(cls)s</span><span class="s1"> iterable is expected. &#39;</span>
                                          <span class="s1">&#39;Got: None&#39;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="p">):</span> <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">val</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rentity</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Item of collection </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> must be an instance of </span><span class="si">%s</span><span class="s1">. Got: </span><span class="si">%r</span><span class="s1">&#39;</span>
                                              <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rentity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">rentity</span><span class="p">):</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Item of collection </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> must be an instance of </span><span class="si">%s</span><span class="s1">. Got: </span><span class="si">%r</span><span class="s1">&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rentity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_session_cache_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;An attempt to mix objects belonging to different transactions&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;load collection&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">del_statuses</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="k">return</span> <span class="n">setdata</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">rentity</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">():</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s2">&quot;Transaction of object </span><span class="si">%s</span><span class="s2"> belongs to different thread&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">reverse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">_vals_</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">-=</span> <span class="n">setdata</span>
                <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span> <span class="n">items</span> <span class="o">-=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span> <span class="k">return</span> <span class="n">setdata</span>

        <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lazy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_construct_batchload_sql_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">setdata</span>

            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">construct_sql_m2m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">loaded_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">rentity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>
            <span class="n">setdata</span> <span class="o">|=</span> <span class="n">loaded_items</span>
            <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_add</span><span class="p">(</span><span class="n">loaded_items</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">setdata</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">collection_statistics</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nplus1_threshold</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">nplus1_threshold</span>
        <span class="n">prefetching</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">PREFETCHING</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span> <span class="ow">and</span> <span class="n">nplus1_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                      <span class="ow">and</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">nplus1_threshold</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">noflush_counter</span><span class="p">)</span>

        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span> <span class="n">obj</span> <span class="p">]</span>
        <span class="n">setdata_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">setdata</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">prefetching</span><span class="p">:</span>
            <span class="n">pk_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
            <span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">max_params_count</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="n">pk_index</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">created_or_deleted_statuses</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">setdata2</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setdata2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata2</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">setdata2</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                <span class="n">setdata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setdata2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_batch_size</span><span class="p">:</span> <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_construct_batchload_sql_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">),</span> <span class="n">reverse</span><span class="p">)</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">construct_sql_m2m</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">pk_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">[:</span><span class="n">pk_len</span><span class="p">])</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">pk_len</span><span class="p">:])</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">items</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">obj2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">rentity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">setdata2</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setdata2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata2</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phantoms</span> <span class="o">=</span> <span class="n">setdata2</span> <span class="o">-</span> <span class="n">items</span>
                    <span class="k">if</span> <span class="n">setdata2</span><span class="o">.</span><span class="n">added</span><span class="p">:</span> <span class="n">phantoms</span> <span class="o">-=</span> <span class="n">setdata2</span><span class="o">.</span><span class="n">added</span>
                    <span class="k">if</span> <span class="n">phantoms</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                        <span class="s1">&#39;Phantom object </span><span class="si">%s</span><span class="s1"> disappeared from collection </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">phantoms</span><span class="o">.</span><span class="n">pop</span><span class="p">()),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">items</span> <span class="o">-=</span> <span class="n">setdata2</span>
                <span class="k">if</span> <span class="n">setdata2</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span> <span class="n">items</span> <span class="o">-=</span> <span class="n">setdata2</span><span class="o">.</span><span class="n">removed</span>
                <span class="n">setdata2</span> <span class="o">|=</span> <span class="n">items</span>
                <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_add</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">obj2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">setdata2</span> <span class="ow">in</span> <span class="n">setdata_list</span><span class="p">:</span>
            <span class="n">setdata2</span><span class="o">.</span><span class="n">is_fully_loaded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">setdata2</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">setdata2</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setdata2</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">collection_statistics</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">setdata</span>
    <span class="k">def</span> <span class="nf">construct_sql_m2m</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">items_count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">items_count</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="o">-</span><span class="n">items_count</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_load_sql</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cached_sql</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">assert</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="n">Entity</span><span class="p">)</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
        <span class="k">assert</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="n">rcolumns</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">rconverters</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span>
            <span class="n">rcolumns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">rconverters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">select_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">rcolumns</span><span class="p">)</span>
        <span class="n">select_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
        <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">table_name</span> <span class="p">]]</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">row_value_syntax</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">translator_cls</span><span class="o">.</span><span class="n">row_value_syntax</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
        <span class="n">where_list</span> <span class="o">+=</span> <span class="n">construct_batchload_criteria_list</span><span class="p">(</span>
            <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">rcolumns</span><span class="p">,</span> <span class="n">rconverters</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">row_value_syntax</span><span class="p">,</span> <span class="n">items_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items_count</span><span class="p">:</span>
            <span class="n">where_list</span> <span class="o">+=</span> <span class="n">construct_batchload_criteria_list</span><span class="p">(</span>
                <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">,</span> <span class="n">items_count</span><span class="p">,</span> <span class="n">row_value_syntax</span><span class="p">)</span>
        <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_load_sql</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="n">reverse</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="ow">or</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">added</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">reverse</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">_wbits_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">|=</span> <span class="n">bit</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">setdata</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">rentity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
        <span class="n">wrapper_class</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_set_wrapper_subclass_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wrapper_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">new_items</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_items</span><span class="p">,</span> <span class="n">SetInstance</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new_items</span><span class="o">.</span><span class="n">_obj_</span> <span class="ow">is</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">new_items</span><span class="o">.</span><span class="n">_attr_</span> <span class="ow">is</span> <span class="n">attr</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># after += or -=</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;change collection&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">new_items</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">new_items</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span>
                    <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
                    <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_items</span> <span class="o">==</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="n">new_items</span> <span class="o">-</span> <span class="n">setdata</span>
            <span class="n">to_remove</span> <span class="o">=</span> <span class="n">setdata</span> <span class="o">-</span> <span class="n">new_items</span>
            <span class="n">is_reverse_call</span> <span class="o">=</span> <span class="n">undo_funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span> <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">_delete_</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">to_add</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_remove</span><span class="p">(</span><span class="n">to_remove</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_add</span><span class="p">(</span><span class="n">to_add</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse_call</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">setdata</span> <span class="o">|=</span> <span class="n">new_items</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_items</span><span class="p">)</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
        <span class="k">if</span> <span class="n">to_add</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span> <span class="p">(</span><span class="n">to_add</span><span class="p">,</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_add</span> <span class="o">-</span> <span class="n">removed</span><span class="p">,</span> <span class="n">removed</span> <span class="o">-</span> <span class="n">to_add</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">added</span><span class="p">:</span> <span class="n">added</span> <span class="o">|=</span> <span class="n">to_add</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">to_add</span>  <span class="c1"># added may be None</span>
        <span class="k">if</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">added</span><span class="p">:</span> <span class="p">(</span><span class="n">to_remove</span><span class="p">,</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_remove</span> <span class="o">-</span> <span class="n">added</span><span class="p">,</span> <span class="n">added</span> <span class="o">-</span> <span class="n">to_remove</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span> <span class="n">removed</span> <span class="o">|=</span> <span class="n">to_remove</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="n">to_remove</span>  <span class="c1"># removed may be None</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reverse_add</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">):</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="n">objects_with_modified_collections</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">setdata</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span>
            <span class="n">in_removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
            <span class="n">was_modified_earlier</span> <span class="o">=</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects_with_modified_collections</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">in_removed</span><span class="p">,</span> <span class="n">was_modified_earlier</span><span class="p">))</span>
            <span class="n">setdata</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">in_removed</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">objects_with_modified_collections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">undo_func</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">in_removed</span><span class="p">,</span> <span class="n">was_modified_earlier</span> <span class="ow">in</span> <span class="n">undo</span><span class="p">:</span>
                <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">setdata</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">in_removed</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">was_modified_earlier</span><span class="p">:</span> <span class="n">objects_with_modified_collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">undo_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">undo_func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">db_reverse_add</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                <span class="s1">&#39;Phantom object </span><span class="si">%s</span><span class="s1"> appeared in collection </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">setdata</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reverse_remove</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">):</span>
        <span class="n">undo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="n">objects_with_modified_collections</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
            <span class="n">in_added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span>
            <span class="n">was_modified_earlier</span> <span class="o">=</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects_with_modified_collections</span>
            <span class="n">undo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">in_added</span><span class="p">,</span> <span class="n">was_modified_earlier</span><span class="p">))</span>
            <span class="n">objects_with_modified_collections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">setdata</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">in_added</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">undo_func</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">in_removed</span><span class="p">,</span> <span class="n">was_modified_earlier</span> <span class="ow">in</span> <span class="n">undo</span><span class="p">:</span>
                <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">setdata</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">in_added</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">was_modified_earlier</span><span class="p">:</span> <span class="n">objects_with_modified_collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">undo_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">undo_func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">db_reverse_remove</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">setdata</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_m2m_columns</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">is_reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">pk_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_get_pk_columns_</span><span class="p">())</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span> <span class="ow">or</span> <span class="n">entity</span> <span class="ow">is</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse</span><span class="p">:</span> <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span> <span class="k">assert</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">_columns_checked</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pk_length</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                    <span class="s1">&#39;Invalid number of columns for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reverse</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_m2m_column_names</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>

            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">:</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;_2&#39;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pk_length</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span> <span class="s2">&quot;Invalid number of reverse columns for symmetric attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;_2&#39;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
                <span class="n">reverse</span><span class="o">.</span><span class="n">_columns_checked</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>
                <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reverse</span> <span class="k">else</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span><span class="p">:</span> <span class="k">return</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">elif</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pk_length</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MappingError</span><span class="p">,</span>
                <span class="s1">&#39;Invalid number of columns for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_default_m2m_column_names</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_columns_checked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">def</span> <span class="nf">remove_m2m</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">removed</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">removed</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_remove_m2m_sql</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span>
                <span class="n">converters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
                <span class="n">converters</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">)):</span>
                <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">])</span>
            <span class="n">from_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">from_ast</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cached_remove_m2m_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span> <span class="o">+</span> <span class="n">robj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
                           <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">robj</span> <span class="ow">in</span> <span class="n">removed</span> <span class="p">]</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments_list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_m2m</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">added</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">added</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_add_m2m_sql</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse_columns</span>
                <span class="n">converters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
                <span class="n">converters</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span> <span class="o">+</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">params</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cached_add_m2m_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span> <span class="o">+</span> <span class="n">robj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
                           <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">robj</span> <span class="ow">in</span> <span class="n">added</span> <span class="p">]</span>
        <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments_list</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">(</span><span class="n">ddl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">with_all_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_table_</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_drop_tables</span><span class="p">([</span> <span class="n">table_name</span> <span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">with_all_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unpickle_setwrapper</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
    <span class="n">wrapper_cls</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="n">_get_set_wrapper_subclass_</span><span class="p">()</span>
    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">wrapper_cls</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
    <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">SetInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;_obj_&#39;</span><span class="p">,</span> <span class="s1">&#39;_attr_&#39;</span><span class="p">,</span> <span class="s1">&#39;_attrnames_&#39;</span>
    <span class="n">_parent_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_attrnames_</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unpickle_setwrapper</span><span class="p">,</span> <span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%r</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">([</span><span class="si">%s</span><span class="s1">])&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">setdata</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="k">return</span> <span class="ow">not</span> <span class="n">setdata</span>
        <span class="k">elif</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">rentity</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_empty_sql</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span><span class="p">)):</span>
                <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_table_</span>
                <span class="n">select_list</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_construct_select_clause_</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
                <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
                <span class="n">attr_offsets</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">table_name</span> <span class="p">]</span> <span class="p">],</span>
                        <span class="n">where_list</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cached_empty_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loaded_item</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">setdata</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">loaded_item</span><span class="p">)</span>
                <span class="n">reverse</span><span class="o">.</span><span class="n">db_reverse_add</span><span class="p">((</span><span class="n">loaded_item</span><span class="p">,),</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">setdata</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetData</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">cached_count_sql</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">reverse</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">converters</span><span class="p">)):</span>
                <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_table_</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">table</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;AGGREGATES&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COUNT&#39;</span><span class="p">,</span> <span class="kc">None</span> <span class="p">]</span> <span class="p">],</span>
                                  <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">table_name</span> <span class="p">]</span> <span class="p">],</span> <span class="n">where_list</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">cached_count_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SetInstance</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">_obj_</span> <span class="ow">and</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">_attr_</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span> <span class="n">other</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">items</span> <span class="o">==</span> <span class="n">other</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">wrapper</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">new_items</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">new_items</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;read value of&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_session_cache_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s1">&#39;An attempt to mix objects belonging to different transactions&#39;</span><span class="p">)</span>

        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">reverse</span><span class="p">]</span> <span class="k">if</span> <span class="n">reverse</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">_vals_</span> <span class="k">else</span> <span class="n">reverse</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">wbits</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_wbits_</span>
            <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">reverse</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">wbits</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">|=</span> <span class="n">bit</span>
            <span class="k">return</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">obj2</span>

        <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reverse_setdata</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reverse_setdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reverse_setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">reverse_setdata</span>
        <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">setdata</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">setdata</span><span class="o">.</span><span class="n">absent</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;When using </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.create(), </span><span class="si">%r</span><span class="s1"> attribute should not be passed explicitly&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">reverse</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="n">item_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item_type</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">new_items</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;change collection&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">new_items</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">new_items</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_items</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">new_items</span> <span class="o">-=</span> <span class="n">setdata</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span>
                <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_items</span><span class="p">)</span>
            <span class="n">new_items</span> <span class="o">-=</span> <span class="n">setdata</span>
            <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_items</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_add</span><span class="p">(</span><span class="n">new_items</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="n">setdata</span> <span class="o">|=</span> <span class="n">new_items</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_items</span><span class="p">)</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span> <span class="p">(</span><span class="n">new_items</span><span class="p">,</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_items</span><span class="o">-</span><span class="n">removed</span><span class="p">,</span> <span class="n">removed</span><span class="o">-</span><span class="n">new_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">added</span><span class="p">:</span> <span class="n">added</span> <span class="o">|=</span> <span class="n">new_items</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">new_items</span>  <span class="c1"># added may be None</span>

        <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;change collection&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">-=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span>
                <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">&amp;=</span> <span class="n">setdata</span>
            <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">_delete_</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_remove</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="n">setdata</span> <span class="o">-=</span> <span class="n">items</span>
        <span class="k">if</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span>
        <span class="k">if</span> <span class="n">added</span><span class="p">:</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">setdata</span><span class="o">.</span><span class="n">added</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span> <span class="o">-</span> <span class="n">added</span><span class="p">,</span> <span class="n">added</span> <span class="o">-</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span> <span class="n">removed</span> <span class="o">|=</span> <span class="n">items</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">setdata</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="n">items</span>  <span class="c1"># removed may be None</span>

        <span class="n">cache</span><span class="o">.</span><span class="n">modified_collections</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;change collection&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attr_</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_select_all</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;lambda item: JOIN(obj in item.</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span> <span class="k">else</span> <span class="s1">&#39;lambda item: item.</span><span class="si">%s</span><span class="s1"> == obj&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">reverse</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;obj&#39;</span> <span class="p">:</span> <span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;JOIN&#39;</span><span class="p">:</span> <span class="n">JOIN</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">select</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">page</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">pagenum</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">pagenum</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sort_by</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unpickle_multiset</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrnames</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">multiset_cls</span> <span class="o">=</span> <span class="n">Multiset</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">multiset_cls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_multiset_subclass_</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">multiset_cls</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Multiset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;_obj_&#39;</span><span class="p">,</span> <span class="s1">&#39;_attrnames_&#39;</span><span class="p">,</span> <span class="s1">&#39;_items_&#39;</span> <span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">multiset</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="n">multiset</span><span class="o">.</span><span class="n">_obj_</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">multiset</span><span class="o">.</span><span class="n">_attrnames_</span> <span class="o">=</span> <span class="n">attrnames</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">=</span> <span class="n">items</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unpickle_multiset</span><span class="p">,</span> <span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_attrnames_</span><span class="p">,</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_obj_</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">itervalues</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">size_str</span> <span class="o">=</span> <span class="s1">&#39; (1 item)&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">size_str</span> <span class="o">=</span> <span class="s1">&#39; (</span><span class="si">%d</span><span class="s1"> items)&#39;</span> <span class="o">%</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">size_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%r</span><span class="s1">.</span><span class="si">%s%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span>
                                 <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_attrnames_</span><span class="p">),</span> <span class="n">size_str</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="n">items_str</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">items_str</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builtins</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">multiset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cnt</span><span class="p">):</span> <span class="k">yield</span> <span class="n">item</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="n">multiset</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Multiset</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_items_</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="n">multiset</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">multiset</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="n">multiset</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">multiset</span><span class="o">.</span><span class="n">_items_</span>

<span class="c1">##class List(Collection): pass</span>
<span class="c1">##class Dict(Collection): pass</span>
<span class="c1">##class Relation(Collection): pass</span>

<span class="k">class</span> <span class="nc">EntityIter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Use select(...) function or </span><span class="si">%s</span><span class="s1">.select(...) method for iteration&#39;</span>
                         <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PY2</span><span class="p">:</span> <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>

<span class="n">entity_id_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new_instance_id_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">select_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;select\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">lambda_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;lambda\b&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EntityMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Entity&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;__slots__&#39;</span> <span class="ow">in</span> <span class="n">cls_dict</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Entity classes cannot contain __slots__ variable&#39;</span><span class="p">)</span>
            <span class="n">cls_dict</span><span class="p">[</span><span class="s1">&#39;__slots__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">EntityMeta</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EntityMeta</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Entity&#39;</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Entity class name should start with a capital letter. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">databases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">base_class</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base_class</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="n">database</span> <span class="o">=</span> <span class="n">base_class</span><span class="o">.</span><span class="n">_database_</span>
                <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Base Entity does not belong to any database&#39;</span><span class="p">)</span>
                <span class="n">databases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">databases</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
            <span class="s1">&#39;With multiple inheritance of entities, all entities must belong to the same database&#39;</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">databases</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
            <span class="s1">&#39;Cannot define entity </span><span class="si">%r</span><span class="s1">: database mapping has already been generated&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span> <span class="o">=</span> <span class="n">database</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_id_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">entity_id_counter</span><span class="p">)</span>
        <span class="n">direct_bases</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__bases__</span> <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Entity</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;Entity&#39;</span> <span class="p">]</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_direct_bases_</span> <span class="o">=</span> <span class="n">direct_bases</span>
        <span class="n">all_bases</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_all_bases_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_subclasses_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">direct_bases</span><span class="p">:</span>
            <span class="n">all_bases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_all_bases_</span><span class="p">)</span>
            <span class="n">all_bases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">all_bases</span><span class="p">:</span>
            <span class="n">base</span><span class="o">.</span><span class="n">_subclasses_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direct_bases</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="o">=</span> <span class="n">direct_bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_root_</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">direct_bases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Multiple inheritance graph must be diamond-like. &#39;</span>
                    <span class="s2">&quot;Entity </span><span class="si">%s</span><span class="s2"> inherits from </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> entities which don&#39;t have common base class.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">_root_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">_discriminator_attr_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">root</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="n">Discriminator</span><span class="o">.</span><span class="n">create_default_attr</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">base_attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_attrs_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">direct_bases</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">base_attrs_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">base_attrs_dict</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="n">base_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                    <span class="s1">&#39;Attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; clashes with attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; in derived entity &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_base_attrs_</span> <span class="o">=</span> <span class="n">base_attrs</span>

        <span class="n">new_attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">items_list</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">base_attrs_dict</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s2">&quot;Name &#39;</span><span class="si">%s</span><span class="s2">&#39; hides base attribute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">base_attrs_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s1">&#39;Attribute name cannot both start and end with underscore. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s1">&#39;Duplicate use of attribute </span><span class="si">%s</span><span class="s1"> in entity </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">new_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">new_attrs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>

        <span class="n">indexes</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_indexes_</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_indexes_&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">new_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Index</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">is_pk</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">PrimaryKey</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span> <span class="n">index</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="n">primary_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">direct_bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">primary_keys</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Primary key cannot be redefined in derived classes&#39;</span><span class="p">)</span>
            <span class="n">base_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">direct_bases</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_indexes_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_indexes</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span> <span class="n">base_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">indexes</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_indexes</span>
            <span class="n">primary_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Only one primary key can be defined in each entity class&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">primary_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s2">&quot;Cannot create default primary key attribute for </span><span class="si">%s</span><span class="s2"> because name &#39;id&#39; is already in use.&quot;</span>
                <span class="s2">&quot; Please create a PrimaryKey attribute for entity </span><span class="si">%s</span><span class="s2"> or rename the &#39;id&#39; attribute&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">PrimaryKey</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">is_implicit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">new_attrs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">pk_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span><span class="p">,)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">is_pk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">indexes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">index</span><span class="o">.</span><span class="n">_init_</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pk_attrs</span> <span class="o">=</span> <span class="n">primary_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk_attrs</span><span class="p">):</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span> <span class="o">=</span> <span class="n">pk_attrs</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_</span> <span class="o">=</span> <span class="n">pk_attrs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">pk_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_keys_</span> <span class="o">=</span> <span class="p">[</span> <span class="n">index</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">is_pk</span> <span class="p">]</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_simple_keys_</span> <span class="o">=</span> <span class="p">[</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_keys_</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">]</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_composite_keys_</span> <span class="o">=</span> <span class="p">[</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_keys_</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">]</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span> <span class="o">=</span> <span class="n">new_attrs</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span> <span class="o">=</span> <span class="n">base_attrs</span> <span class="o">+</span> <span class="n">new_attrs</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_subclass_attrs_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_subclass_adict_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_all_bases_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">new_attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_subclass_adict_</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                    <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> conflicts with attribute </span><span class="si">%s</span><span class="s1"> because both entities inherit from </span><span class="si">%s</span><span class="s1">. &#39;</span>
                    <span class="s1">&#39;To fix this, move attribute definition to base class&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="n">base</span><span class="o">.</span><span class="n">_subclass_attrs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_attrnames_cache_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_table_&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">._table_ property must be a string. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">name_part</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span><span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                        <span class="s1">&#39;Each part of table name must be a string. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name_part</span><span class="p">)</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="o">=</span> <span class="n">table_name</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

        <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_cached_max_id_sql_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_find_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_load_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_batchload_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_insert_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_update_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_delete_sql_cache_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_propagation_mixin_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_set_wrapper_subclass_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_multiset_subclass_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;_discriminator_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span><span class="p">:</span>
            <span class="n">Discriminator</span><span class="o">.</span><span class="n">create_default_attr</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span><span class="p">:</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span><span class="o">.</span><span class="n">process_entity_inheritance</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

        <span class="n">iter_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_default_iter_name_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">letter</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="ow">or</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>
        <span class="n">for_expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprFor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AssName</span><span class="p">(</span><span class="n">iter_name</span><span class="p">,</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">),</span> <span class="p">[])</span>
        <span class="n">inner_expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprInner</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">iter_name</span><span class="p">),</span> <span class="p">[</span> <span class="n">for_expr</span> <span class="p">])</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_default_genexpr_</span> <span class="o">=</span> <span class="n">inner_expr</span>

        <span class="n">entity</span><span class="o">.</span><span class="n">_access_rules_</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_initialize_bits_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_bits_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_bits_except_volatile_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">offset_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">all_bits</span> <span class="o">=</span> <span class="n">all_bits_except_volatile</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_discriminator</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">offset_counter</span><span class="p">)</span>
            <span class="n">all_bits</span> <span class="o">|=</span> <span class="n">bit</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_bits_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span><span class="p">:</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">all_bits_except_volatile</span> <span class="o">|=</span> <span class="n">bit</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_all_bits_</span> <span class="o">=</span> <span class="n">all_bits</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_all_bits_except_volatile_</span> <span class="o">=</span> <span class="n">all_bits_except_volatile</span>
    <span class="k">def</span> <span class="nf">_resolve_attr_types_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
            <span class="n">py_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">rentity</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rentity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Entity definition </span><span class="si">%s</span><span class="s1"> was not found&#39;</span> <span class="o">%</span> <span class="n">py_type</span><span class="p">)</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="o">=</span> <span class="n">py_type</span> <span class="o">=</span> <span class="n">rentity</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                <span class="n">rentity</span> <span class="o">=</span> <span class="n">py_type</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rentity</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Invalid type of attribute </span><span class="si">%s</span><span class="s1">: expected entity class, got </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">rentity</span><span class="p">))</span>
                <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="o">=</span> <span class="n">py_type</span> <span class="o">=</span> <span class="n">rentity</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Entity&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;Cannot link attribute </span><span class="si">%s</span><span class="s1"> to abstract Entity class. Use specific Entity subclass instead&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_link_reverse_attrs_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
            <span class="n">py_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span> <span class="k">continue</span>

            <span class="n">entity2</span> <span class="o">=</span> <span class="n">py_type</span>
            <span class="k">if</span> <span class="n">entity2</span><span class="o">.</span><span class="n">_database_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Interrelated entities must belong to same database. &#39;</span>
                                   <span class="s1">&#39;Entities </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> belongs to different databases&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">entity2</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">attr2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity2</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Reverse attribute </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity2</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                <span class="n">attr2</span> <span class="o">=</span> <span class="n">reverse</span>
                <span class="k">if</span> <span class="n">attr2</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity2</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Incorrect reverse attribute </span><span class="si">%s</span><span class="s1"> used in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr2</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="c1">###</span>
            <span class="k">elif</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s2">&quot;Value of &#39;reverse&#39; option must be string. Got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">reverse</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidates1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">candidates2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">attr2</span> <span class="ow">in</span> <span class="n">entity2</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr2</span><span class="o">.</span><span class="n">py_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="n">reverse2</span> <span class="o">=</span> <span class="n">attr2</span><span class="o">.</span><span class="n">reverse</span>
                    <span class="k">if</span> <span class="n">reverse2</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">):</span> <span class="n">candidates1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">reverse2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr2</span> <span class="ow">is</span> <span class="n">attr</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">candidates2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr2</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Ambiguous reverse attribute for </span><span class="si">%s</span><span class="s2">. Use the &#39;reverse&#39; parameter for pointing to right attribute&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr2</span> <span class="o">=</span> <span class="n">candidates1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">attr2</span> <span class="o">=</span> <span class="n">candidates2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Reverse attribute for </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

            <span class="n">type2</span> <span class="o">=</span> <span class="n">attr2</span><span class="o">.</span><span class="n">py_type</span>
            <span class="k">if</span> <span class="n">type2</span> <span class="o">!=</span> <span class="n">entity</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Inconsistent reverse attributes </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr2</span><span class="p">))</span>
            <span class="n">reverse2</span> <span class="o">=</span> <span class="n">attr2</span><span class="o">.</span><span class="n">reverse</span>
            <span class="k">if</span> <span class="n">reverse2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Inconsistent reverse attributes </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr2</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_required</span> <span class="ow">and</span> <span class="n">attr2</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span>
                <span class="s2">&quot;At least one attribute of one-to-one relationship </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2"> must be optional&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr2</span><span class="p">))</span>

            <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">attr2</span>
            <span class="n">attr2</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">linked</span><span class="p">()</span>
            <span class="n">attr2</span><span class="o">.</span><span class="n">linked</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_check_table_options_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_table_options_&#39;</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;Cannot redefine </span><span class="si">%s</span><span class="s1"> options in </span><span class="si">%s</span><span class="s1"> entity&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_root_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;_table_options_&#39;</span><span class="p">):</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_table_options_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">_get_pk_columns_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_converters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">:</span>
            <span class="n">attr_columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_columns</span><span class="p">()</span>
            <span class="n">attr_col_paths</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">col_paths</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">pk_columns_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span>
            <span class="n">pk_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr_columns</span><span class="p">)</span>
            <span class="n">pk_converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
            <span class="n">pk_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr_col_paths</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span> <span class="o">=</span> <span class="n">pk_columns</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span> <span class="o">=</span> <span class="n">pk_converters</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_nones_</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_pk_paths_</span> <span class="o">=</span> <span class="n">pk_paths</span>
        <span class="k">return</span> <span class="n">pk_columns</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">EntityIter</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Invalid count of attrs in </span><span class="si">%s</span><span class="s1"> primary key (</span><span class="si">%s</span><span class="s1"> instead of </span><span class="si">%s</span><span class="s1">)&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">)))</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">,</span> <span class="n">key</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_one_</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_query_from_args_</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_one_</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">MultipleObjectsFoundError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_query_from_args_</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_one_</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># can throw MultipleObjectsFoundError</span>
        <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get_for_update</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nowait</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nowait&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_query_from_args_</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">for_update</span><span class="p">(</span><span class="n">nowait</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_one_</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">nowait</span><span class="p">)</span>  <span class="c1"># can throw MultipleObjectsFoundError</span>
        <span class="k">except</span> <span class="n">ObjectNotFound</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get_by_sql</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_by_sql_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># can throw MultipleObjectsFoundError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_query_from_args_</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">select_by_sql</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_by_sql_</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">select_random</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">max_id</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_id_sql</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_cached_max_id_sql_</span>
            <span class="k">if</span> <span class="n">max_id_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;AGGREGATES&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;MAX&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pk</span><span class="o">.</span><span class="n">column</span> <span class="p">]</span> <span class="p">]</span> <span class="p">],</span>
                                      <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
                <span class="n">max_id_sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_cached_max_id_sql_</span> <span class="o">=</span> <span class="n">max_id_sql</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">max_id_sql</span><span class="p">)</span>
            <span class="n">max_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">max_id_cache</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_id</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tried_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">found_in_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">tried_ids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">found_in_cache</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tried_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span> <span class="k">break</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_batchload_sql_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">from_seeds</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">([</span> <span class="p">(</span><span class="nb">id</span><span class="p">,)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span> <span class="p">])</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
            <span class="n">tried_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span> <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_subclasses_</span><span class="p">:</span>
            <span class="n">seeds</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">seeds</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">found_in_cache</span><span class="p">:</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">_find_one_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Mapping is not generated for entity </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">avdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">get_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="o">.</span><span class="n">get</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">get_attr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Unknown attribute </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span>
            <span class="n">pkval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">avdict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">))</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">pkval</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">avdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Collection attribute </span><span class="si">%s</span><span class="s1"> cannot be specified as search criteria&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">obj</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_in_cache_</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="n">avdict</span><span class="p">,</span> <span class="n">for_update</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_in_db_</span><span class="p">(</span><span class="n">avdict</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">for_update</span><span class="p">,</span> <span class="n">nowait</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_find_in_cache_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">,</span> <span class="n">avdict</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">cache_indexes</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_simple_keys_</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">avdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
                <span class="n">get_val</span> <span class="o">=</span> <span class="n">avdict</span><span class="o">.</span><span class="n">get</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
                <span class="k">if</span> <span class="n">reverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_subclasses_</span><span class="p">:</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
                        <span class="n">throw</span><span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
                    <span class="n">seeds</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">for_update</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unique</span>  <span class="c1"># object is found, but it is not locked</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_set_rbits</span><span class="p">((</span><span class="n">obj</span><span class="p">,),</span> <span class="n">avdict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">unique</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unique</span>
    <span class="k">def</span> <span class="nf">_find_in_db_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">avdict</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">query_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">)}</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">unique</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_sql_</span><span class="p">(</span><span class="n">query_attrs</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">for_update</span><span class="p">,</span> <span class="n">nowait</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">avdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">for_update</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">for_update</span><span class="p">,</span> <span class="n">avdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">objects</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_find_by_sql_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">max_fetch_count</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">column_info</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span> <span class="p">]</span>
        <span class="n">attr_offsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">used_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_subclass_attrs_</span><span class="p">):</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">col_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">break</span>
                <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">used_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">attr_offsets</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_columns</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NameError</span><span class="p">,</span>
                    <span class="s1">&#39;Column </span><span class="si">%s</span><span class="s1"> does not belong to entity </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr_offsets</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                <span class="s1">&#39;Primary key attribue </span><span class="si">%s</span><span class="s1"> was not found in query result set&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

        <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">max_fetch_count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objects</span>
    <span class="k">def</span> <span class="nf">_construct_select_clause_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">query_attrs</span><span class="o">=</span><span class="p">(),</span> <span class="n">attrs_to_prefetch</span><span class="o">=</span><span class="p">(),</span> <span class="n">all_attributes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">attr_offsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DISTINCT&#39;</span> <span class="p">]</span> <span class="k">if</span> <span class="n">distinct</span> <span class="k">else</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">_subclass_attrs_</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_attributes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> \
                                  <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span> <span class="ow">or</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">query_attrs</span> <span class="ow">or</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_prefetch</span><span class="p">:</span>
                <span class="n">attr_offsets</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">select_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">])</span>
        <span class="k">return</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">attr_offsets</span>
    <span class="k">def</span> <span class="nf">_construct_discriminator_criteria_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">discr_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span>
        <span class="k">if</span> <span class="n">discr_attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">code2cls</span> <span class="o">=</span> <span class="n">discr_attr</span><span class="o">.</span><span class="n">code2cls</span>
        <span class="n">discr_values</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_discriminator_</span> <span class="p">]</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_subclasses_</span> <span class="p">]</span>
        <span class="n">discr_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">discr_attr</span><span class="o">.</span><span class="n">column</span> <span class="p">],</span> <span class="n">discr_values</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">_construct_batchload_sql_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_seeds</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">query_key</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">from_seeds</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_batchload_sql_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cached_sql</span>
        <span class="n">select_list</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_select_clause_</span><span class="p">(</span><span class="n">all_attributes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]]</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
        <span class="n">row_value_syntax</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">translator_cls</span><span class="o">.</span><span class="n">row_value_syntax</span>
        <span class="n">criteria_list</span> <span class="o">=</span> <span class="n">construct_batchload_criteria_list</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">row_value_syntax</span><span class="p">,</span> <span class="n">from_seeds</span><span class="o">=</span><span class="n">from_seeds</span><span class="p">)</span>
        <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="n">criteria_list</span> <span class="p">]</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_batchload_sql_cache_</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="k">return</span> <span class="n">cached_sql</span>
    <span class="k">def</span> <span class="nf">_construct_sql_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">query_attrs</span><span class="p">,</span> <span class="n">order_by_pk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nowait</span><span class="p">:</span> <span class="k">assert</span> <span class="n">for_update</span>
        <span class="n">sorted_query_attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">query_key</span> <span class="o">=</span> <span class="n">sorted_query_attrs</span><span class="p">,</span> <span class="n">order_by_pk</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">for_update</span><span class="p">,</span> <span class="n">nowait</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_find_sql_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">cached_sql</span>
        <span class="n">select_list</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_select_clause_</span><span class="p">(</span><span class="n">query_attrs</span><span class="o">=</span><span class="n">query_attrs</span><span class="p">)</span>
        <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]]</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>

        <span class="n">discr_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span>
        <span class="k">if</span> <span class="n">discr_attr</span> <span class="ow">and</span> <span class="n">query_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">discr_attr</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">discr_criteria</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_discriminator_criteria_</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">discr_criteria</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discr_criteria</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_is_none</span> <span class="ow">in</span> <span class="n">sorted_query_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr_is_none</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;IS_NULL&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="p">]</span> <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="n">converter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">])</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr_entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">;</span> <span class="k">assert</span> <span class="n">attr_entity</span> <span class="o">==</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">entity</span>
                <span class="k">if</span> <span class="n">attr_is_none</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;IS_NULL&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">attr_entity</span><span class="o">.</span><span class="n">_pk_converters_</span><span class="p">)):</span>
                        <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">for_update</span><span class="p">:</span> <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT_FOR_UPDATE&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">nowait</span><span class="p">),</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">order_by_pk</span><span class="p">:</span> <span class="n">sql_ast</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;ORDER_BY&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span> <span class="p">])</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sql_ast</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span> <span class="n">limit</span> <span class="p">])</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_find_sql_cache_</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="k">return</span> <span class="n">cached_sql</span>
    <span class="k">def</span> <span class="nf">_fetch_objects</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">max_fetch_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">used_attrs</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">max_fetch_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">max_fetch_count</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">MAX_FETCH_COUNT</span>
        <span class="k">if</span> <span class="n">max_fetch_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">max_fetch_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_fetch_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_fetch_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MultipleObjectsFoundError</span><span class="p">,</span>
                    <span class="s1">&#39;Multiple objects were found. Use </span><span class="si">%s</span><span class="s1">.select(...) to retrieve them&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">TooManyObjectsFoundError</span><span class="p">,</span>
                    <span class="s1">&#39;Found more then pony.options.MAX_FETCH_COUNT=</span><span class="si">%d</span><span class="s1"> objects&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">MAX_FETCH_COUNT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">attr_offsets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">for_update</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="p">]</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_load_many_</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">real_entity_subclass</span><span class="p">,</span> <span class="n">pkval</span><span class="p">,</span> <span class="n">avdict</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_parse_row_</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">real_entity_subclass</span><span class="o">.</span><span class="n">_get_from_identity_map_</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="n">for_update</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_db_set_</span><span class="p">(</span><span class="n">avdict</span><span class="p">)</span>
                <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">used_attrs</span><span class="p">:</span> <span class="n">entity</span><span class="o">.</span><span class="n">_set_rbits</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">used_attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objects</span>
    <span class="k">def</span> <span class="nf">_set_rbits</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">rbits_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">get_rbits</span> <span class="o">=</span> <span class="n">rbits_dict</span><span class="o">.</span><span class="n">get</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
            <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">rbits</span> <span class="o">=</span> <span class="n">get_rbits</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rbits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rbits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="n">rbits_dict</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbits</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">|=</span> <span class="n">rbits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">wbits</span>
    <span class="k">def</span> <span class="nf">_parse_row_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">):</span>
        <span class="n">discr_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">discr_attr</span><span class="p">:</span>
            <span class="n">discr_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">real_entity_subclass</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">discr_offset</span> <span class="o">=</span> <span class="n">attr_offsets</span><span class="p">[</span><span class="n">discr_attr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">discr_value</span> <span class="o">=</span> <span class="n">discr_attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">discr_offset</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">real_entity_subclass</span> <span class="o">=</span> <span class="n">discr_attr</span><span class="o">.</span><span class="n">code2cls</span><span class="p">[</span><span class="n">discr_value</span><span class="p">]</span>
            <span class="n">discr_value</span> <span class="o">=</span> <span class="n">real_entity_subclass</span><span class="o">.</span><span class="n">_discriminator_</span>  <span class="c1"># To convert unicode to str in Python 2.x</span>

        <span class="n">avdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">real_entity_subclass</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">attr_offsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offsets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_discriminator</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>

        <span class="n">pkval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">avdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">discr_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">)</span>
        <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">real_entity_subclass</span><span class="p">,</span> <span class="n">pkval</span><span class="p">,</span> <span class="n">avdict</span>
    <span class="k">def</span> <span class="nf">_load_many_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">seeds</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seeds</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">}</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_pkval_&#39;</span><span class="p">))</span>
        <span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">max_params_count</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[:</span><span class="n">max_batch_size</span><span class="p">]</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="n">max_batch_size</span><span class="p">:]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_batchload_sql_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                                               <span class="s1">&#39;Phantom object </span><span class="si">%s</span><span class="s1"> disappeared&#39;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_select_all</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_default_iter_name_</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_default_genexpr_</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="s1">&#39;.0&#39;</span> <span class="p">:</span> <span class="n">entity</span> <span class="p">})</span>
    <span class="k">def</span> <span class="nf">_query_from_args_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_select_all</span><span class="p">()</span>
        <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">get_lambda_args</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">code_key</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">func_code</span> <span class="k">if</span> <span class="n">PY2</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">)</span>
            <span class="n">cond_expr</span><span class="p">,</span> <span class="n">external_names</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">code_key</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">lambda_ast</span> <span class="o">=</span> <span class="n">string2ast</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lambda_ast</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Lambda function is expected. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">get_lambda_args</span><span class="p">(</span><span class="n">lambda_ast</span><span class="p">)</span>
            <span class="n">cond_expr</span> <span class="o">=</span> <span class="n">lambda_ast</span><span class="o">.</span><span class="n">code</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Lambda query requires exactly one parameter name, like </span><span class="si">%s</span><span class="s1">.select(lambda </span><span class="si">%s</span><span class="s1">: ...). &#39;</span>
            <span class="s1">&#39;Got: </span><span class="si">%d</span><span class="s1"> parameters&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">if_expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprIf</span><span class="p">(</span><span class="n">cond_expr</span><span class="p">)</span>
        <span class="n">for_expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprFor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AssName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">),</span> <span class="p">[</span> <span class="n">if_expr</span> <span class="p">])</span>
        <span class="n">inner_expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprInner</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">[</span> <span class="n">for_expr</span> <span class="p">])</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="nb">locals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="s1">&#39;.0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span>
        <span class="nb">locals</span><span class="p">[</span><span class="s1">&#39;.0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">inner_expr</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_from_identity_map_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">pkval</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj_to_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">pk_attrs</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span>
        <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">pk_attrs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pkval</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">CacheIndexError</span><span class="p">,</span> <span class="s1">&#39;Cannot create </span><span class="si">%s</span><span class="s1">: instance with primary key </span><span class="si">%s</span><span class="s1"> already exists&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pkval</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">entity</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span>
            <span class="s1">&#39;Unexpected class change from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> for object with primary key </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">entity</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">obj_to_init</span>
                <span class="k">if</span> <span class="n">obj_to_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span> <span class="o">=</span> <span class="n">pkval</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span> <span class="o">=</span> <span class="n">cache</span>
                <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cache_index</span><span class="p">[</span><span class="n">pkval</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_newid_</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_newid_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">new_instance_id_counter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">izip</span><span class="p">(</span><span class="n">pk_attrs</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">pairs</span> <span class="o">=</span> <span class="p">((</span><span class="n">pk_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkval</span><span class="p">),)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;loaded&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">undo_funcs</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">pk_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">undo_funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="n">for_update</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cache</span><span class="o">.</span><span class="n">in_transaction</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">raw_pkval</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pkval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">raw_pkval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="n">from_db</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">((</span><span class="n">val</span><span class="p">,),</span> <span class="n">from_db</span><span class="o">=</span><span class="n">from_db</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">raw_pkval</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="o">.</span><span class="n">_get_by_raw_pkval_</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="n">from_db</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">pkval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_from_identity_map_</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="n">for_update</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">def</span> <span class="nf">_get_propagation_mixin_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">mixin</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_propagation_mixin_</span>
        <span class="k">if</span> <span class="n">mixin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">mixin</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;_entity_&#39;</span> <span class="p">:</span> <span class="n">entity</span> <span class="p">}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">):</span>
                    <span class="n">attrnames</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attrnames_</span> <span class="o">+</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">wrapper</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="ow">is</span> <span class="n">Json</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[</span> <span class="n">item</span><span class="o">.</span><span class="n">get_untracked</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">TrackedValue</span><span class="p">)</span> <span class="k">else</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="p">]</span>
                    <span class="k">return</span> <span class="n">Multiset</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">):</span>
                    <span class="n">attrnames</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attrnames_</span> <span class="o">+</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">wrapper</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">]</span>
                    <span class="n">rentity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_multiset_subclass_</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">fget</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">):</span>
                    <span class="n">cache</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">collection_statistics</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">nplus1_threshold</span><span class="p">)</span>
                    <span class="n">attrnames</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">_attrnames_</span> <span class="o">+</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span> <span class="n">subitem</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">wrapper</span>
                                      <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">]</span>
                    <span class="n">rentity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">rentity</span><span class="o">.</span><span class="n">_get_multiset_subclass_</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">_obj_</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
            <span class="n">cls_dict</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="p">)</span>
        <span class="n">result_cls_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;SetMixin&#39;</span>
        <span class="n">result_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_cls_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="n">cls_dict</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_propagation_mixin_</span> <span class="o">=</span> <span class="n">result_cls</span>
        <span class="k">return</span> <span class="n">result_cls</span>
    <span class="k">def</span> <span class="nf">_get_multiset_subclass_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">result_cls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_multiset_subclass_</span>
        <span class="k">if</span> <span class="n">result_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_propagation_mixin_</span><span class="p">()</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Multiset&#39;</span>
            <span class="n">result_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="p">(</span><span class="n">Multiset</span><span class="p">,</span> <span class="n">mixin</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_multiset_subclass_</span> <span class="o">=</span> <span class="n">result_cls</span>
        <span class="k">return</span> <span class="n">result_cls</span>
    <span class="k">def</span> <span class="nf">_get_set_wrapper_subclass_</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">result_cls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_set_wrapper_subclass_</span>
        <span class="k">if</span> <span class="n">result_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mixin</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_propagation_mixin_</span><span class="p">()</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Set&#39;</span>
            <span class="n">result_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="p">(</span><span class="n">SetInstance</span><span class="p">,</span> <span class="n">mixin</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_set_wrapper_subclass_</span> <span class="o">=</span> <span class="n">result_cls</span>
        <span class="k">return</span> <span class="n">result_cls</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class </span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">):&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">parents</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_base_attrs_</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# inherited attrs&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_base_attrs_</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# attrs introduced in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_new_attrs_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PrimaryKey(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="nd">@db_session</span><span class="p">(</span><span class="n">ddl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">with_all_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_drop_tables</span><span class="p">([</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">with_all_data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_attrs_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_collections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">only</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">only</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">only</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">exclude</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">only</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">with_collections</span><span class="p">,</span> <span class="n">with_lazy</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrnames_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">append</span>
            <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">only</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">only</span> <span class="o">=</span> <span class="n">only</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">get_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="o">.</span><span class="n">get</span>
                <span class="k">for</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">only</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">get_attr</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span>
                        <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> does not have attriute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">with_collections</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">with_lazy</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span> <span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attrname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span>
                        <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> does not have attriute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_attrnames_cache_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="k">return</span> <span class="n">attrs</span>

<span class="k">def</span> <span class="nf">populate_criteria_list</span><span class="p">(</span><span class="n">criteria_list</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">converters</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span>
                           <span class="n">params_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">table_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">converters</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;IS_NULL&#39;</span><span class="p">:</span>
            <span class="n">criteria_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">op</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">]</span> <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">criteria_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="n">op</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="n">table_alias</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span>
                                       <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">params_count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span><span class="p">,</span> <span class="n">optimistic</span> <span class="p">]</span> <span class="p">])</span>
        <span class="n">params_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">params_count</span>

<span class="n">statuses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">}</span>
<span class="n">del_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marked_to_delete&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">}</span>
<span class="n">created_or_deleted_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;created&#39;</span><span class="p">}</span> <span class="o">|</span> <span class="n">del_statuses</span>
<span class="n">saved_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="s1">&#39;deleted&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span>
    <span class="n">throw</span><span class="p">(</span><span class="n">OperationWithDeletedObjectError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> was </span><span class="si">%s</span><span class="s1">&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">unpickle_entity</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__class__&#39;</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_from_identity_map_</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="k">return</span> <span class="n">obj</span>
    <span class="n">avdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">[</span><span class="n">attrname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_db_set_</span><span class="p">(</span><span class="n">avdict</span><span class="p">,</span> <span class="n">unpickling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">def</span> <span class="nf">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Entity</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Entity</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">EntityMeta</span><span class="p">)):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;_session_cache_&#39;</span><span class="p">,</span> <span class="s1">&#39;_status_&#39;</span><span class="p">,</span> <span class="s1">&#39;_pkval_&#39;</span><span class="p">,</span> <span class="s1">&#39;_newid_&#39;</span><span class="p">,</span> <span class="s1">&#39;_dbvals_&#39;</span><span class="p">,</span> <span class="s1">&#39;_vals_&#39;</span><span class="p">,</span> <span class="s1">&#39;_rbits_&#39;</span><span class="p">,</span> <span class="s1">&#39;_wbits_&#39;</span><span class="p">,</span> <span class="s1">&#39;_save_pos_&#39;</span><span class="p">,</span> <span class="s1">&#39;__weakref__&#39;</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span>
            <span class="n">OperationWithDeletedObjectError</span><span class="p">,</span> <span class="s1">&#39;Deleted object </span><span class="si">%s</span><span class="s1"> cannot be pickled&#39;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span>
            <span class="n">OrmError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> object </span><span class="si">%s</span><span class="s1"> has to be stored in DB before it can be pickled&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_status_</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__class__&#39;</span> <span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">}</span>
        <span class="n">adict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_adict_</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">unpickle_entity</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> constructor accept only keyword arguments. Got: </span><span class="si">%d</span><span class="s1"> positional argument</span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;s&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Mapping is not generated for entity </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">avdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Unknown attribute </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">DEFAULT</span><span class="p">)</span>
            <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span>
            <span class="n">pkval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">avdict</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">))</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">pkval</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="n">avdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">cache_indexes</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span>
        <span class="n">indexes_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_simple_keys_</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span> <span class="n">throw</span><span class="p">(</span><span class="n">CacheIndexError</span><span class="p">,</span>
                    <span class="s1">&#39;Cannot create </span><span class="si">%s</span><span class="s1">: value </span><span class="si">%r</span><span class="s1"> for key </span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">indexes_update</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attrs</span><span class="p">]:</span>
                    <span class="n">attr_names</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                    <span class="n">throw</span><span class="p">(</span><span class="n">CacheIndexError</span><span class="p">,</span> <span class="s1">&#39;Cannot create </span><span class="si">%s</span><span class="s1">: value </span><span class="si">%s</span><span class="s1"> for composite key (</span><span class="si">%s</span><span class="s1">) already exists&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">attr_names</span><span class="p">))</span>
                <span class="n">indexes_update</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">_get_from_identity_map_</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="o">=</span><span class="n">undo_funcs</span><span class="p">,</span> <span class="n">obj_to_init</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">][</span><span class="n">pkval</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">indexes_update</span><span class="p">):</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">vals</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
        <span class="n">objects_to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">get_pk</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">pkval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">pkval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pkval</span>
    <span class="k">def</span> <span class="nf">_get_raw_pkval_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">pkval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">pkval</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">pkval</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
        <span class="n">raw_pkval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">append</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="n">raw_pkval</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="n">raw_pkval</span><span class="o">.</span><span class="n">extend</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">,</span> <span class="n">pkval</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">extend</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">raw_pkval</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_cmp_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_cmp_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_cmp_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_cmp_</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">_cmp_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="n">other</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
            <span class="n">pkval</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pkval_</span>
            <span class="n">other_pkval</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_pkval_</span>
            <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other_pkval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">pkval</span><span class="p">,</span> <span class="n">other_pkval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other_pkval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_newid_</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_newid_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">pkval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span>
        <span class="k">if</span> <span class="n">pkval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">[new:</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_newid_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_is_composite_</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">pkval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">pkval</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pkval</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pkval</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_load_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;load object&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">():</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> doesn&#39;t belong to current transaction&quot;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">seeds</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
        <span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">max_params_count</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span> <span class="n">obj</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">PREFETCHING</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_batch_size</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span> <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_construct_batchload_sql_</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">))</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                                     <span class="s1">&#39;Phantom object </span><span class="si">%s</span><span class="s1"> disappeared&#39;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;load object&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">():</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">TransactionError</span><span class="p">,</span> <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> doesn&#39;t belong to current transaction&quot;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">created_or_deleted_statuses</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_bits_</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">bit</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">attrs</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ident</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid attribute name: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
                        <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="s1">&#39;Object </span><span class="si">%s</span><span class="s1"> does not have attribute </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">arg</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span>
                        <span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> does not belong to object </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Invalid argument type: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span>
                    <span class="s1">&#39;The load() method does not support collection attributes yet. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_bits_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">:</span> <span class="n">attrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)))</span>

        <span class="n">sql_cache</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_root_</span><span class="o">.</span><span class="n">_load_sql_cache_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">sql_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span><span class="p">,)</span> <span class="o">+</span> <span class="n">attrs</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span> <span class="o">+</span> <span class="n">attrs</span>

            <span class="n">attr_offsets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">attr_offsets</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">select_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">])</span>
            <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]]</span>
            <span class="n">criteria_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">]</span>
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_converters_</span><span class="p">))</span> <span class="p">]</span>
            <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="n">criteria_list</span>

            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span>
            <span class="n">sql_cache</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                                     <span class="s1">&#39;Phantom object </span><span class="si">%s</span><span class="s1"> disappeared&#39;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_attr_changed_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;assign new value to&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
        <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bit</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">|=</span> <span class="n">bit</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                <span class="n">objects_to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="nf">_db_set_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">avdict</span><span class="p">,</span> <span class="n">unpickling</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">created_or_deleted_statuses</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">assert</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">avdict</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">get_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span>
        <span class="n">get_dbval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="o">.</span><span class="n">get</span>
        <span class="n">rbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span>
        <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_dbval</span> <span class="ow">in</span> <span class="n">items_list</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">new_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span>
            <span class="n">old_dbval</span> <span class="o">=</span> <span class="n">get_dbval</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">NOT_LOADED</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unpickling</span> <span class="ow">or</span> <span class="n">old_dbval</span> <span class="o">==</span> <span class="n">new_dbval</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dbvals_equal</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)):</span>
                    <span class="k">del</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="k">continue</span>

            <span class="n">bit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_except_volatile_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rbits</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span>
                <span class="n">errormsg</span> <span class="o">=</span> <span class="s1">&#39;Please contact PonyORM developers so they can &#39;</span> \
                           <span class="s1">&#39;reproduce your error and fix a bug: support@ponyorm.com&#39;</span>
                <span class="k">assert</span> <span class="n">old_dbval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_LOADED</span><span class="p">,</span> <span class="n">errormsg</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">UnrepeatableReadError</span><span class="p">,</span>
                      <span class="s1">&#39;Value of </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> was updated outside of current transaction (was: </span><span class="si">%r</span><span class="s1">, now: </span><span class="si">%r</span><span class="s1">)&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">db_update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dbval</span>
            <span class="k">if</span> <span class="n">wbits</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">:</span> <span class="k">del</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">old_val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_val</span> <span class="o">!=</span> <span class="n">new_dbval</span><span class="p">:</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">db_update_simple_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">get_val</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="p">]</span>  <span class="c1"># In Python 2 var name leaks into the function scope!</span>
                <span class="n">prev_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">db_update_composite_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">attr</span>
                <span class="n">converter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">dbval2val</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
    <span class="k">def</span> <span class="nf">_delete_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">is_recursive_call</span> <span class="o">=</span> <span class="n">undo_funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_recursive_call</span><span class="p">:</span> <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">assert</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">get_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span>
            <span class="n">undo_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
            <span class="n">save_pos</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span>

            <span class="k">def</span> <span class="nf">undo_func</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">objects_to_save</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">objects_to_save</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span>
                    <span class="k">if</span> <span class="n">save_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">objects_to_save</span><span class="p">[</span><span class="n">save_pos</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="n">objects_to_save</span><span class="p">[</span><span class="n">save_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="n">save_pos</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">for</span> <span class="n">cache_index</span><span class="p">,</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">undo_list</span><span class="p">:</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">old_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

            <span class="n">undo_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">undo_func</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
                        <span class="n">set_wrapper</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_wrapper</span><span class="o">.</span><span class="n">__nonzero__</span><span class="p">():</span> <span class="k">pass</span>
                        <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">robj</span> <span class="ow">in</span> <span class="n">set_wrapper</span><span class="p">:</span> <span class="n">robj</span><span class="o">.</span><span class="n">_delete_</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(),</span> <span class="n">undo_funcs</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ConstraintError</span><span class="p">,</span> <span class="s2">&quot;Cannot delete object </span><span class="si">%s</span><span class="s2">, because it has non-empty set of </span><span class="si">%s</span><span class="s2">, &quot;</span>
                                                     <span class="s2">&quot;and &#39;cascade_delete&#39; option of </span><span class="si">%s</span><span class="s2"> is not set&quot;</span>
                                                     <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="n">reverse</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">cascade_delete</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">_delete_</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="n">reverse</span><span class="o">.</span><span class="n">is_required</span><span class="p">:</span> <span class="n">reverse</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ConstraintError</span><span class="p">,</span> <span class="s2">&quot;Cannot delete object </span><span class="si">%s</span><span class="s2">, because it has associated </span><span class="si">%s</span><span class="s2">, &quot;</span>
                                                         <span class="s2">&quot;and &#39;cascade_delete&#39; option of </span><span class="si">%s</span><span class="s2"> is not set&quot;</span>
                                                         <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">:</span> <span class="k">continue</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                            <span class="n">reverse</span><span class="o">.</span><span class="n">reverse_remove</span><span class="p">((</span><span class="n">val</span><span class="p">,),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>

                <span class="n">cache_indexes</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_simple_keys_</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span>
                    <span class="n">undo_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span>
                    <span class="n">undo_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">save_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">objects_to_save</span><span class="p">[</span><span class="n">save_pos</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pk_index</span> <span class="o">=</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span>
                        <span class="n">obj2</span> <span class="o">=</span> <span class="n">pk_index</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span>
                        <span class="n">undo_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pk_index</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">save_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="n">objects_to_save</span><span class="p">[</span><span class="n">save_pos</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">save_pos</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                    <span class="n">objects_to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;marked_to_delete&#39;</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_recursive_call</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">undo_funcs</span><span class="p">):</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;delete object&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_delete_</span><span class="p">()</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span> <span class="n">throw_db_session_is_over</span><span class="p">(</span><span class="s1">&#39;change object&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">del_statuses</span><span class="p">:</span> <span class="n">throw_object_was_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">avdict</span><span class="p">,</span> <span class="n">collection_avdict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_keyargs_to_avdicts_</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
            <span class="n">wbits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span>
            <span class="n">get_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span>
            <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
            <span class="k">if</span> <span class="n">avdict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># loading of one-to-one relations</span>

                <span class="k">if</span> <span class="n">wbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_wbits</span> <span class="o">=</span> <span class="n">wbits</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span> <span class="n">new_wbits</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="n">new_wbits</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                        <span class="n">objects_to_save</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="n">cache</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">collection_avdict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_part_of_unique_index</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">avdict</span><span class="p">)</span>
                        <span class="k">return</span>

                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items_list</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                        <span class="n">avdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="n">undo_funcs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">undo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">undo_func</span><span class="p">():</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="n">wbits</span>
                <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">objects_to_save</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">objects_to_save</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">assert</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">cache_index</span><span class="p">,</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">undo</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">del</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">old_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache_index</span><span class="p">[</span><span class="n">old_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_simple_keys_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">old_val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">update_simple_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_composite_keys_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">):</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span> <span class="n">get_val</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="p">]</span>  <span class="c1"># In Python 2 var name leaks into the function scope!</span>
                        <span class="n">prev_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">avdict</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                        <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                        <span class="n">cache</span><span class="o">.</span><span class="n">update_composite_index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">prev_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">undo</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">avdict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">old_val</span> <span class="o">=</span> <span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">update_reverse</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">collection_avdict</span><span class="p">):</span>
                    <span class="n">attr</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">undo_funcs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">undo_func</span> <span class="ow">in</span> <span class="n">undo_funcs</span><span class="p">:</span> <span class="n">undo_func</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">avdict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_keyargs_to_avdicts_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">avdict</span><span class="p">,</span> <span class="n">collection_avdict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">get_attr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_adict_</span><span class="o">.</span><span class="n">get</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">get_attr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Unknown attribute </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">new_val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">collection_avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">avdict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
            <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">new_val</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Cannot change value of primary key attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avdict</span><span class="p">,</span> <span class="n">collection_avdict</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_attrs_with_bit_</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">get_bit</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_bits_</span><span class="o">.</span><span class="n">get</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span> <span class="k">yield</span> <span class="n">attr</span>
    <span class="k">def</span> <span class="nf">_construct_optimistic_criteria_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">optimistic_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">optimistic_converters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">optimistic_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">optimistic_operations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_bit_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span><span class="p">):</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span>
            <span class="k">assert</span> <span class="n">converters</span>
            <span class="n">optimistic</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">optimistic</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">optimistic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">optimistic</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">optimistic</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">dbval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">optimistic_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">optimistic_converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_raw_values</span><span class="p">(</span><span class="n">dbval</span><span class="p">)</span>
            <span class="n">optimistic_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">optimistic_operations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39;IS_NULL&#39;</span> <span class="k">if</span> <span class="n">dbval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span> <span class="k">for</span> <span class="n">converter</span> <span class="ow">in</span> <span class="n">converters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimistic_operations</span><span class="p">,</span> <span class="n">optimistic_columns</span><span class="p">,</span> <span class="n">optimistic_converters</span><span class="p">,</span> <span class="n">optimistic_values</span>
    <span class="k">def</span> <span class="nf">_save_principal_objects_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dependent_objects</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependent_objects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dependent_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">dependent_objects</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obj2</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">dependent_objects</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">UnresolvableCyclicDependency</span><span class="p">,</span> <span class="s1">&#39;Cannot save cyclic chain: &#39;</span> <span class="o">+</span> <span class="n">chain</span><span class="p">)</span>
        <span class="n">dependent_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_bit_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">_status_</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span>
                <span class="n">val</span><span class="o">.</span><span class="n">_save_</span><span class="p">(</span><span class="n">dependent_objects</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_dbvals_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">after_create</span><span class="p">,</span> <span class="n">new_dbvals</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_bits_</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span>
        <span class="n">dbvals</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span>
        <span class="n">cache_indexes</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span><span class="o">.</span><span class="n">indexes</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_volatile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span> <span class="n">cache_indexes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">get_val</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">composite_keys</span><span class="p">:</span>
                        <span class="n">keyval</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_val</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)</span>
                        <span class="n">cache_indexes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keyval</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">after_create</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">new_dbvals</span><span class="p">:</span>
                    <span class="n">dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="c1"># Clear value of volatile attribute or null values after create, because the value may be changed in the DB</span>
            <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">dbvals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_created_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">auto_pk</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_dbvals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auto_pk</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_pk</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">dbval</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">val2dbval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="n">new_dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbval</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get_raw_values</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>

        <span class="n">database</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_insert_sql_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>  <span class="n">converter</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">dialect</span> <span class="o">==</span> <span class="s1">&#39;Oracle&#39;</span><span class="p">:</span>
                <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">,</span>
                            <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;DEFAULT&#39;</span> <span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_columns_</span> <span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">params</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">auto_pk</span><span class="p">:</span> <span class="n">sql_ast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">_insert_sql_cache_</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>

        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auto_pk</span><span class="p">:</span> <span class="n">new_id</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">returning_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">TransactionIntegrityError</span><span class="p">,</span>
                  <span class="s1">&#39;Object </span><span class="si">%r</span><span class="s1"> cannot be stored in the database. </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">UnexpectedError</span><span class="p">,</span> <span class="s1">&#39;Object </span><span class="si">%r</span><span class="s1"> cannot be stored in the database. </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">auto_pk</span><span class="p">:</span>
            <span class="n">pk_attrs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span>
            <span class="n">cache_index</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">pk_attrs</span><span class="p">]</span>
            <span class="n">obj2</span> <span class="o">=</span> <span class="n">cache_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TransactionIntegrityError</span><span class="p">,</span>
                <span class="s1">&#39;Newly auto-generated id value </span><span class="si">%s</span><span class="s1"> was already used in transaction cache for another object&#39;</span> <span class="o">%</span> <span class="n">new_id</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">pk_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_id</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_newid_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;inserted&#39;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_all_bits_except_volatile_</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_update_dbvals_</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">new_dbvals</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_save_updated_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">update_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_dbvals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_bit_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span><span class="p">):</span>
            <span class="n">update_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">dbval</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">val2dbval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">new_dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbval</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dbval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dbvals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get_raw_values</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">update_columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get_raw_values</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
            <span class="n">optimistic_session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">optimistic</span>
            <span class="k">if</span> <span class="n">optimistic_session</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
                <span class="n">optimistic_ops</span><span class="p">,</span> <span class="n">optimistic_columns</span><span class="p">,</span> <span class="n">optimistic_converters</span><span class="p">,</span> <span class="n">optimistic_values</span> <span class="o">=</span> \
                    <span class="n">obj</span><span class="o">.</span><span class="n">_construct_optimistic_criteria_</span><span class="p">()</span>
                <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">optimistic_values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">optimistic_columns</span> <span class="o">=</span> <span class="n">optimistic_converters</span> <span class="o">=</span> <span class="n">optimistic_ops</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">query_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update_columns</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">optimistic_columns</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">optimistic_ops</span><span class="p">)</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span>
            <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_update_sql_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_converters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_bit_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span><span class="p">):</span>
                    <span class="n">update_converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_converters</span><span class="p">)</span>
                <span class="n">update_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">converter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">update_converters</span><span class="p">)</span> <span class="p">]</span>
                <span class="n">params_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">update_params</span><span class="p">)</span>
                <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
                <span class="n">pk_columns</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_columns_</span>
                <span class="n">pk_converters</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_converters_</span>
                <span class="n">params_count</span> <span class="o">=</span> <span class="n">populate_criteria_list</span><span class="p">(</span><span class="n">where_list</span><span class="p">,</span> <span class="n">pk_columns</span><span class="p">,</span> <span class="n">pk_converters</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;EQ&#39;</span><span class="p">),</span> <span class="n">params_count</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">optimistic_columns</span><span class="p">:</span> <span class="n">populate_criteria_list</span><span class="p">(</span>
                    <span class="n">where_list</span><span class="p">,</span> <span class="n">optimistic_columns</span><span class="p">,</span> <span class="n">optimistic_converters</span><span class="p">,</span> <span class="n">optimistic_ops</span><span class="p">,</span> <span class="n">params_count</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_table_</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">update_columns</span><span class="p">,</span> <span class="n">update_params</span><span class="p">)),</span> <span class="n">where_list</span> <span class="p">]</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_update_sql_cache_</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">optimistic</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="n">OptimisticCheckError</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">find_updated_attributes</span><span class="p">())</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;updated&#39;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">&amp;</span> <span class="n">obj</span><span class="o">.</span><span class="n">_all_bits_except_volatile_</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_wbits_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_update_dbvals_</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_dbvals</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_save_deleted_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="n">optimistic_session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">optimistic</span>
        <span class="k">if</span> <span class="n">optimistic_session</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="n">optimistic_ops</span><span class="p">,</span> <span class="n">optimistic_columns</span><span class="p">,</span> <span class="n">optimistic_converters</span><span class="p">,</span> <span class="n">optimistic_values</span> <span class="o">=</span> \
                <span class="n">obj</span><span class="o">.</span><span class="n">_construct_optimistic_criteria_</span><span class="p">()</span>
            <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">optimistic_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">optimistic_columns</span> <span class="o">=</span> <span class="n">optimistic_converters</span> <span class="o">=</span> <span class="n">optimistic_ops</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">query_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">optimistic_columns</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">optimistic_ops</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">cached_sql</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_delete_sql_cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_sql</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">where_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span>
            <span class="n">params_count</span> <span class="o">=</span> <span class="n">populate_criteria_list</span><span class="p">(</span><span class="n">where_list</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_pk_converters_</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;EQ&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">optimistic_columns</span><span class="p">:</span> <span class="n">populate_criteria_list</span><span class="p">(</span>
                <span class="n">where_list</span><span class="p">,</span> <span class="n">optimistic_columns</span><span class="p">,</span> <span class="n">optimistic_converters</span><span class="p">,</span> <span class="n">optimistic_ops</span><span class="p">,</span> <span class="n">params_count</span><span class="p">,</span> <span class="n">optimistic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">from_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">from_ast</span><span class="p">,</span> <span class="n">where_list</span> <span class="p">]</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_delete_sql_cache_</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cached_sql</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">start_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">optimistic</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="n">OptimisticCheckError</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">find_updated_attributes</span><span class="p">())</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="o">=</span> <span class="s1">&#39;deleted&#39;</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pkval_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_updated_attributes</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">attrs_to_select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attrs_to_select</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">)</span>
        <span class="n">discr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_discriminator_attr_</span>
        <span class="k">if</span> <span class="n">discr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">discr</span><span class="o">.</span><span class="n">pk_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attrs_to_select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_bit_</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_attrs_with_columns_</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_rbits_</span><span class="p">):</span>
            <span class="n">optimistic</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">optimistic</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">optimistic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">optimistic</span>
            <span class="k">if</span> <span class="n">optimistic</span><span class="p">:</span>
                <span class="n">attrs_to_select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="n">optimistic_converters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attr_offsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">select_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ALL&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_select</span><span class="p">:</span>
            <span class="n">optimistic_converters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">)</span>
            <span class="n">attr_offsets</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">select_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="p">])</span>
                <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">from_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">_table_</span> <span class="p">]</span> <span class="p">]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span>
        <span class="n">pk_converters</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_pk_converters_</span>
        <span class="n">criteria_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">converter</span><span class="o">.</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;COLUMN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">column</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">converter</span> <span class="p">]</span> <span class="p">]</span>
                          <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">,</span> <span class="n">pk_converters</span><span class="p">))</span> <span class="p">]</span>
        <span class="n">sql_ast</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">,</span> <span class="n">select_list</span><span class="p">,</span> <span class="n">from_list</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;WHERE&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="n">criteria_list</span> <span class="p">]</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">())</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> was deleted outside of current transaction&quot;</span> <span class="o">%</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">real_entity_subclass</span><span class="p">,</span> <span class="n">pkval</span><span class="p">,</span> <span class="n">avdict</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_parse_row_</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_dbval</span> <span class="ow">in</span> <span class="n">avdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old_dbval</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_dbvals_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_dbval</span> <span class="o">!=</span> <span class="n">new_dbval</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">converter</span><span class="o">.</span><span class="n">dbvals_equal</span><span class="p">(</span><span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">)):</span>
                <span class="n">diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">old_dbval</span><span class="p">,</span> <span class="n">new_dbval</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;Object </span><span class="si">%s</span><span class="s2"> was updated outside of current transaction</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">safe_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;. Changes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="k">if</span> <span class="n">diff</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_save_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dependent_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_save_principal_objects_</span><span class="p">(</span><span class="n">dependent_objects</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_created_</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_updated_</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_deleted_</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;_save_() called for object </span><span class="si">%r</span><span class="s2"> with incorrect status </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">in</span> <span class="n">saved_statuses</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">assert</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span><span class="p">))</span>
        <span class="n">objects_to_save</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">objects_to_save</span>
        <span class="n">save_pos</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span>
        <span class="k">if</span> <span class="n">save_pos</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_to_save</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">objects_to_save</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objects_to_save</span><span class="p">[</span><span class="n">save_pos</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;modified&#39;</span><span class="p">,</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="n">obj</span><span class="o">.</span><span class="n">_save_pos_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;save_pos is None for </span><span class="si">%s</span><span class="s1"> object&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">assert</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">saved_objects</span>
        <span class="k">with</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush_disabled</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_before_save_</span><span class="p">()</span> <span class="c1"># should be inside flush_disabled to prevent infinite recursion</span>
                                <span class="c1"># TODO: add to documentation that flush is disabled inside before_xxx hooks</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_save_</span><span class="p">()</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">call_after_save_hooks</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_before_save_</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_status_</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">before_insert</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;modified&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">before_update</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;marked_to_delete&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">before_delete</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">before_insert</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">before_update</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">before_delete</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">_after_save_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;inserted&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">after_insert</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">after_update</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">after_delete</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">after_insert</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">after_update</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">after_delete</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_collections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">related_objects</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_session_cache_</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">is_alive</span> <span class="ow">and</span> <span class="n">cache</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_get_attrs_</span><span class="p">(</span><span class="n">only</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">with_collections</span><span class="p">,</span> <span class="n">with_lazy</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">related_objects</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_columns_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">related_objects</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_get_raw_pkval_</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">(),</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_database_</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">with_schema</span><span class="p">,</span> <span class="n">schema_hash</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">string2ast</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">string2ast_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
    <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;The bytestring </span><span class="si">%r</span><span class="s1"> contains non-ascii symbols. Try to pass unicode string instead&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;backslashreplace&#39;</span><span class="p">)</span>
    <span class="n">module_node</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span>
    <span class="n">stmt_node</span> <span class="o">=</span> <span class="n">module_node</span><span class="o">.</span><span class="n">node</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Stmt</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">stmt_node</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span>
    <span class="n">discard_node</span> <span class="o">=</span> <span class="n">stmt_node</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discard_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Discard</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">string2ast_cache</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">discard_node</span><span class="o">.</span><span class="n">expr</span>
    <span class="c1"># result = deepcopy(result)  # no need for now, but may be needed later</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="p">,</span> <span class="n">from_generator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">args_len</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">from_generator</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;The first positional argument must be generator expression or its text source. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;The first positional argument must be lambda function or its text source. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">globals</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;The second positional arguments should be globals dictionary. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">globals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">locals</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">locals</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;The third positional arguments should be locals dictionary. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="nb">locals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">:</span>
            <span class="nb">locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="nb">locals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">gi_frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Excess positional argument</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="s1">&#39;s&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">frame_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">locals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">frame_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">gi_frame</span><span class="o">.</span><span class="n">f_globals</span>
            <span class="nb">locals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">gi_frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">frame_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">frame_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Keyword arguments cannot be specified together with positional arguments&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span>

<span class="k">def</span> <span class="nf">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="p">,</span> <span class="n">left_join</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">gen</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">frame_depth</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">frame_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">from_generator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
        <span class="n">tree</span><span class="p">,</span> <span class="n">external_names</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="n">code_key</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">gi_frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">string2ast</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExpr</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Source code should represent generator. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">code_key</span> <span class="o">=</span> <span class="n">gen</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">left_join</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">left_join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">left_join</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_query</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_aggrfunc</span><span class="p">(</span><span class="n">std_func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">aggrfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">std_func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">gi_frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;.0&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="n">std_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">EntityIter</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">std_func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">std_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">aggrfunc</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">std_func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">aggrfunc</span>

<span class="n">count</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
<span class="nb">sum</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">builtins</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
<span class="nb">min</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">builtins</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="nb">max</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">builtins</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="n">avg</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>
<span class="n">group_concat</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">group_concat</span><span class="p">)</span>

<span class="n">distinct</span> <span class="o">=</span> <span class="n">make_aggrfunc</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">distinct</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">JOIN</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">expr</span>

<span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">desc</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">DescWrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">attr</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">int_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">expr</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;desc(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">expr</span>
    <span class="k">return</span> <span class="n">expr</span>

<span class="k">def</span> <span class="nf">raw_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">globals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="k">return</span> <span class="n">RawSQL</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">result_type</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_vars</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
        <span class="nb">locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_contents</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">NameError</span><span class="p">,</span> <span class="s1">&#39;Free variable `</span><span class="si">%s</span><span class="s1">` referenced before assignment in enclosing scope&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vartypes</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">extractor</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">extractors</span><span class="p">):</span>
        <span class="n">varkey</span> <span class="o">=</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">code_key</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cause</span><span class="p">:</span> <span class="k">raise</span> <span class="n">ExprEvalError</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">cause</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">make_query</span><span class="p">((</span><span class="n">value</span><span class="p">,),</span> <span class="n">frame_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryResultIterator</span><span class="p">):</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_query_result</span>
            <span class="k">if</span> <span class="n">query_result</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">query_result</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">_position</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_query_result</span><span class="o">.</span><span class="n">_query</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">value</span>
            <span class="nb">vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span>
            <span class="n">vartypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">vartypes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">vartypes</span><span class="p">[</span><span class="n">varkey</span><span class="p">],</span> <span class="n">value</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">unsupported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="n">unsupported</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">unsupported</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">unsupported</span><span class="p">:</span>
                <span class="n">typename</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;.0&#39;</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Query cannot iterate over anything but entity class or another query&#39;</span><span class="p">)</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Expression `</span><span class="si">%s</span><span class="s1">` has unsupported type </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">typename</span><span class="p">))</span>
            <span class="n">vartypes</span><span class="p">[</span><span class="n">varkey</span><span class="p">],</span> <span class="n">value</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">vars</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span>

<span class="k">def</span> <span class="nf">unpickle_query</span><span class="p">(</span><span class="n">query_result</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">query_result</span>

<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">code_key</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">left_join</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">GenExprInner</span><span class="p">)</span>
        <span class="n">tree</span><span class="p">,</span> <span class="n">extractors</span> <span class="o">=</span> <span class="n">create_extractors</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">special_functions</span><span class="p">,</span> <span class="n">const_functions</span><span class="p">)</span>
        <span class="n">filter_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span>
        <span class="n">varkey</span> <span class="o">=</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">code_key</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
            <span class="n">prev_query</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">QueryResult</span><span class="p">):</span>
            <span class="n">prev_query</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">_query</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">QueryResultIterator</span><span class="p">):</span>
            <span class="n">prev_query</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">_query_result</span><span class="o">.</span><span class="n">_query</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_query</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">EntityIter</span><span class="p">):</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">entity</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;.0&#39;</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Query can only iterate over entity or another query (not a list of objects)&#39;</span><span class="p">)</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Cannot iterate over non-entity object </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">_database_</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">,</span> <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> is not mapped to a database&#39;</span> <span class="o">%</span> <span class="n">origin</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">ERDiagramError</span><span class="p">,</span> <span class="s1">&#39;Mapping is not generated for entity </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">origin</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prev_query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">prev_query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">database</span>
            <span class="n">filter_num</span> <span class="o">=</span> <span class="n">prev_query</span><span class="o">.</span><span class="n">_filter_num</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">code_key</span><span class="p">,</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">_filter_num</span> <span class="o">=</span> <span class="n">filter_num</span>
        <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">normalize_vars</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">_code_key</span> <span class="o">=</span> <span class="n">code_key</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">code_key</span><span class="o">=</span><span class="n">code_key</span><span class="p">,</span> <span class="n">vartypes</span><span class="o">=</span><span class="n">vartypes</span><span class="p">,</span> <span class="n">left_join</span><span class="o">=</span><span class="n">left_join</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">())</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">database</span>

        <span class="n">translator</span><span class="p">,</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_get_translator</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="nb">vars</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="nb">vars</span>

        <span class="k">if</span> <span class="n">translator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pickled_tree</span> <span class="o">=</span> <span class="n">pickle_ast</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">unpickle_ast</span><span class="p">(</span><span class="n">pickled_tree</span><span class="p">)</span>  <span class="c1"># tree = deepcopy(tree)</span>
            <span class="n">translator_cls</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">translator_cls</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">translator</span> <span class="o">=</span> <span class="n">translator_cls</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">code_key</span><span class="p">,</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">left_join</span><span class="o">=</span><span class="n">left_join</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">UseAnotherTranslator</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">translator</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">translator</span>
            <span class="n">name_path</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">can_be_optimized</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name_path</span><span class="p">:</span>
                <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">unpickle_ast</span><span class="p">(</span><span class="n">pickled_tree</span><span class="p">)</span>  <span class="c1"># tree = deepcopy(tree)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">translator</span> <span class="o">=</span> <span class="n">translator_cls</span><span class="p">(</span><span class="n">tree_copy</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">code_key</span><span class="p">,</span> <span class="n">filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                <span class="n">left_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">name_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">UseAnotherTranslator</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">translator</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">translator</span>
                <span class="k">except</span> <span class="n">OptimizationFailed</span><span class="p">:</span>
                    <span class="n">translator</span><span class="o">.</span><span class="n">optimization_failed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">translator</span><span class="o">.</span><span class="n">pickled_tree</span> <span class="o">=</span> <span class="n">pickled_tree</span>
            <span class="k">if</span> <span class="n">translator</span><span class="o">.</span><span class="n">can_be_cached</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">translator</span>

        <span class="n">query</span><span class="o">.</span><span class="n">_translator</span> <span class="o">=</span> <span class="n">translator</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_next_kwarg_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_for_update</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_nowait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_prefetch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_entities_to_prefetch</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_type_</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QueryType</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_normalize_var</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query_type</span><span class="p">,</span> <span class="n">query</span>
    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_query</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Query</span><span class="p">)</span>
        <span class="n">new_query</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">new_query</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_query</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unpickle_query</span><span class="p">,</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(),)</span>
    <span class="k">def</span> <span class="nf">_get_translator</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_key</span><span class="p">,</span> <span class="nb">vars</span><span class="p">):</span>
        <span class="n">new_vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="n">all_func_vartypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">translator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">translator</span><span class="o">.</span><span class="n">func_extractors_map</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_extractors</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">func_extractors_map</span><span class="p">):</span>
                    <span class="n">func_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">func_code</span> <span class="k">if</span> <span class="n">PY2</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">)</span>
                    <span class="n">func_filter_num</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">func_id</span>
                    <span class="n">func_vars</span><span class="p">,</span> <span class="n">func_vartypes</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span>
                        <span class="n">func_id</span><span class="p">,</span> <span class="n">func_filter_num</span><span class="p">,</span> <span class="n">func_extractors</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="p">{},</span> <span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">)</span>  <span class="c1"># todo closures</span>
                    <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">normalize_vars</span><span class="p">(</span><span class="n">func_vars</span><span class="p">,</span> <span class="n">func_vartypes</span><span class="p">)</span>
                    <span class="n">new_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func_vars</span><span class="p">)</span>
                    <span class="n">all_func_vartypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func_vartypes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">all_func_vartypes</span> <span class="o">!=</span> <span class="n">translator</span><span class="o">.</span><span class="n">func_vartypes</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">getattr_values</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_vars</span>
                <span class="k">if</span> <span class="n">attrname</span> <span class="o">!=</span> <span class="n">new_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="n">database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">translator</span><span class="p">,</span> <span class="n">new_vars</span>
    <span class="k">def</span> <span class="nf">_construct_sql_and_arguments</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggr_func_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggr_func_distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="n">expr_type</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span><span class="p">:</span>
            <span class="n">attrs_to_prefetch</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr_type</span><span class="p">,</span> <span class="p">())))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs_to_prefetch</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">sql_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span>
            <span class="n">vartypes</span><span class="o">=</span><span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">vartypes</span><span class="p">),</span>
            <span class="n">getattr_values</span><span class="o">=</span><span class="n">HashableDict</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">getattr_values</span><span class="p">),</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">distinct</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span>
            <span class="n">aggr_func</span><span class="o">=</span><span class="p">(</span><span class="n">aggr_func_name</span><span class="p">,</span> <span class="n">aggr_func_distinct</span><span class="p">,</span> <span class="n">sep</span><span class="p">),</span>
            <span class="n">for_update</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">,</span>
            <span class="n">nowait</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_nowait</span><span class="p">,</span>
            <span class="n">inner_join_syntax</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">INNER_JOIN_SYNTAX</span><span class="p">,</span>
            <span class="n">attrs_to_prefetch</span><span class="o">=</span><span class="n">attrs_to_prefetch</span>
        <span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span>
        <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_constructed_sql_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sql_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql_ast</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">construct_sql_ast</span><span class="p">(</span>
                <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span> <span class="n">aggr_func_name</span><span class="p">,</span> <span class="n">aggr_func_distinct</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                <span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">_nowait</span><span class="p">,</span> <span class="n">attrs_to_prefetch</span><span class="p">)</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span>
            <span class="n">database</span><span class="o">.</span><span class="n">_constructed_sql_cache</span><span class="p">[</span><span class="n">sql_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_entry</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">attr_offsets</span> <span class="o">=</span> <span class="n">cache_entry</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">query_result_is_cacheable</span><span class="p">:</span>
            <span class="n">arguments_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">else</span> <span class="n">arguments</span>
            <span class="k">try</span><span class="p">:</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arguments_key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="n">query_key</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># arguments are unhashable</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">query_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">sql_key</span><span class="p">,</span> <span class="n">arguments_key</span><span class="o">=</span><span class="n">arguments_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">query_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">query_key</span>
    <span class="k">def</span> <span class="nf">get_sql</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">query_key</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_construct_sql_and_arguments</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sql</span>
    <span class="k">def</span> <span class="nf">_actual_fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">query_key</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_construct_sql_and_arguments</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>  <span class="c1"># may clear cache.query_results</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_fetch_objects</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_for_update</span><span class="p">,</span>
                                               <span class="n">used_attrs</span><span class="o">=</span><span class="n">translator</span><span class="o">.</span><span class="n">get_used_attrs</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">row_layout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">func</span><span class="p">,</span> <span class="n">slice_or_offset</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">row_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">starmap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">sql_row</span><span class="p">[</span><span class="n">slice_or_offset</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">slice_or_offset</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">translator</span><span class="o">.</span><span class="n">row_layout</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">sql_row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">_subclasses_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">_load_many_</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_dblocal</span><span class="o">.</span><span class="n">stats</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">cache_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="n">sql</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueryStat</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">_do_prefetch</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_entities_to_prefetch</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_entities_to_prefetch</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                             <span class="n">_attrs_to_prefetch_dict</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_prefetch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> belongs to different database and cannot be prefetched&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">query</span><span class="o">.</span><span class="n">_entities_to_prefetch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">entity</span>
                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">_database_</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                    <span class="s1">&#39;Entity of attribute </span><span class="si">%s</span><span class="s1"> belongs to different database and cannot be prefetched&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">py_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">)</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Argument of prefetch() query method must be entity class or attribute. &#39;</span>
                                   <span class="s1">&#39;Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>
    <span class="k">def</span> <span class="nf">_do_prefetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">expr_type</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="n">object_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">object_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">append_to_object_list</span> <span class="o">=</span> <span class="n">object_list</span><span class="o">.</span><span class="n">append</span>
        <span class="n">add_to_object_set</span> <span class="o">=</span> <span class="n">object_set</span><span class="o">.</span><span class="n">add</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                    <span class="n">add_to_object_set</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="n">append_to_object_list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expr_type</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                        <span class="n">add_to_object_set</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="n">append_to_object_list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">entities_to_prefetch</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_entities_to_prefetch</span>
        <span class="n">attrs_to_prefetch_dict</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_attrs_to_prefetch_dict</span>
        <span class="n">prefetching_attrs_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_list</span><span class="p">:</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">_pk_attrs_</span><span class="p">]:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_load_</span><span class="p">()</span>

            <span class="n">all_attrs_to_prefetch</span> <span class="o">=</span> <span class="n">prefetching_attrs_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_attrs_to_prefetch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_attrs_to_prefetch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">append</span> <span class="o">=</span> <span class="n">all_attrs_to_prefetch</span><span class="o">.</span><span class="n">append</span>
                <span class="n">attrs_to_prefetch</span> <span class="o">=</span> <span class="n">attrs_to_prefetch_dict</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_attrs_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_prefetch</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_prefetch</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">py_type</span> <span class="ow">in</span> <span class="n">entities_to_prefetch</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_to_prefetch</span><span class="p">:</span> <span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">prefetching_attrs_cache</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_attrs_to_prefetch</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">all_attrs_to_prefetch</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
                    <span class="n">setdata</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_vals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">setdata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">setdata</span><span class="o">.</span><span class="n">is_fully_loaded</span><span class="p">:</span> <span class="n">setdata</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">setdata</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">obj2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                            <span class="n">add_to_object_set</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                            <span class="n">append_to_object_list</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                    <span class="n">obj2</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_set</span><span class="p">:</span>
                        <span class="n">add_to_object_set</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                        <span class="n">append_to_object_list</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">MultipleObjectsFoundError</span><span class="p">,</span>
            <span class="s1">&#39;Multiple objects were found. Use select(...) to retrieve them&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="k">if</span> <span class="n">translator</span><span class="o">.</span><span class="n">order</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">without_distinct</span><span class="p">()[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">without_distinct</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_distinct</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bulk</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;Delete query should be applied to a single entity. Got: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="n">ast2src</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">_delete_</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="n">sql_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">sql_command</span><span class="o">=</span><span class="s1">&#39;DELETE&#39;</span><span class="p">)</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_constructed_sql_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sql_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql_ast</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">construct_delete_sql_ast</span><span class="p">()</span>
            <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">ast2sql</span><span class="p">(</span><span class="n">sql_ast</span><span class="p">)</span>
            <span class="n">database</span><span class="o">.</span><span class="n">_constructed_sql_cache</span><span class="p">[</span><span class="n">sql_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_entry</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">cache_entry</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">prepare_connection_for_query_execution</span><span class="p">()</span>  <span class="c1"># may clear cache.query_results</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_order_by</span><span class="p">(</span><span class="s1">&#39;order_by&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">sort_by</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_order_by</span><span class="p">(</span><span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_order_by</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">() method requires at least one argument&#39;</span> <span class="o">%</span> <span class="n">method_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;When first argument of </span><span class="si">%s</span><span class="s1">() method is None, it must be the only argument&#39;</span> <span class="o">%</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;without_order&#39;</span><span class="p">,),)</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">)</span>
            <span class="n">new_filters</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_filters</span> <span class="o">+</span> <span class="n">tup</span>

            <span class="n">new_translator</span><span class="p">,</span> <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_get_translator</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_translator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">without_order</span><span class="p">()</span>
                <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_translator</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_key</span><span class="o">=</span><span class="n">new_key</span><span class="p">,</span> <span class="n">_filters</span><span class="o">=</span><span class="n">new_filters</span><span class="p">,</span> <span class="n">_translator</span><span class="o">=</span><span class="n">new_translator</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)):</span>
            <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_process_lambda</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">RawSQL</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">raw</span><span class="p">)</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="n">numbers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">int_types</span><span class="p">):</span> <span class="n">numbers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">DescWrapper</span><span class="p">)):</span> <span class="n">attributes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;order_by() method receive an argument of invalid type: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numbers</span> <span class="ow">and</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;order_by() method receive invalid combination of arguments&#39;</span><span class="p">)</span>

        <span class="n">tup</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;order_by_numbers&#39;</span> <span class="k">if</span> <span class="n">numbers</span> <span class="k">else</span> <span class="s1">&#39;order_by_attributes&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">),)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">)</span>
        <span class="n">new_filters</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_filters</span> <span class="o">+</span> <span class="n">tup</span>

        <span class="n">new_translator</span><span class="p">,</span> <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_get_translator</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_translator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numbers</span><span class="p">:</span> <span class="n">new_translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">order_by_numbers</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">new_translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">order_by_attributes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_translator</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_key</span><span class="o">=</span><span class="n">new_key</span><span class="p">,</span> <span class="n">_filters</span><span class="o">=</span><span class="n">new_filters</span><span class="p">,</span> <span class="n">_translator</span><span class="o">=</span><span class="n">new_translator</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_process_lambda</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">original_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">prev_translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">func_id</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">func_ast</span> <span class="o">=</span> <span class="n">string2ast</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_ast</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">):</span>
                <span class="n">argnames</span> <span class="o">=</span> <span class="n">get_lambda_args</span><span class="p">(</span><span class="n">func_ast</span><span class="p">)</span>
                <span class="n">func_ast</span> <span class="o">=</span> <span class="n">func_ast</span><span class="o">.</span><span class="n">code</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
            <span class="n">argnames</span> <span class="o">=</span> <span class="n">get_lambda_args</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">func_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">func_code</span> <span class="k">if</span> <span class="n">PY2</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">)</span>
            <span class="n">func_ast</span><span class="p">,</span> <span class="n">external_names</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">order_by</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Argument of filter() method must be a lambda functon or its text. Got: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">if</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">original_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                        <span class="s1">&#39;Lambda argument `</span><span class="si">%s</span><span class="s1">` does not correspond to any variable in original query&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expr_type</span> <span class="o">=</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">expr_type</span>
                <span class="n">expr_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr_type</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr_type</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expr_count</span><span class="p">:</span>
                    <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;Incorrect number of lambda arguments. &#39;</span>
                                     <span class="s1">&#39;Expected: </span><span class="si">%d</span><span class="s1">, got: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_names</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_filter_num</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_filter_num</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">func_ast</span><span class="p">,</span> <span class="n">extractors</span> <span class="o">=</span> <span class="n">create_extractors</span><span class="p">(</span>
            <span class="n">func_id</span><span class="p">,</span> <span class="n">func_ast</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">special_functions</span><span class="p">,</span> <span class="n">const_functions</span><span class="p">,</span> <span class="n">argnames</span> <span class="ow">or</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extractors</span><span class="p">:</span>
            <span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span> <span class="n">new_filter_num</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">normalize_vars</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">)</span>
            <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">new_vars</span><span class="p">,</span> <span class="n">vartypes</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="p">,</span> <span class="n">HashableDict</span><span class="p">()</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;order_by&#39;</span> <span class="k">if</span> <span class="n">order_by</span> <span class="k">else</span> <span class="s1">&#39;where&#39;</span> <span class="k">if</span> <span class="n">original_names</span> <span class="k">else</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">func_id</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">),)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">)</span>
        <span class="n">new_filters</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_filters</span> <span class="o">+</span> <span class="p">((</span><span class="s1">&#39;apply_lambda&#39;</span><span class="p">,</span> <span class="n">func_id</span><span class="p">,</span> <span class="n">new_filter_num</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">func_ast</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">original_names</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">),)</span>

        <span class="n">new_translator</span><span class="p">,</span> <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_get_translator</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_translator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_optimized</span> <span class="o">=</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">optimize</span>
            <span class="n">new_translator</span> <span class="o">=</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">apply_lambda</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span> <span class="n">new_filter_num</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">func_ast</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">original_names</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prev_optimized</span><span class="p">:</span>
                <span class="n">name_path</span> <span class="o">=</span> <span class="n">new_translator</span><span class="o">.</span><span class="n">can_be_optimized</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name_path</span><span class="p">:</span>
                    <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">unpickle_ast</span><span class="p">(</span><span class="n">prev_translator</span><span class="o">.</span><span class="n">pickled_tree</span><span class="p">)</span>  <span class="c1"># tree = deepcopy(tree)</span>
                    <span class="n">translator_cls</span> <span class="o">=</span> <span class="n">prev_translator</span><span class="o">.</span><span class="vm">__class__</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_translator</span> <span class="o">=</span> <span class="n">translator_cls</span><span class="p">(</span>
                            <span class="n">tree_copy</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">original_code_key</span><span class="p">,</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">original_filter_num</span><span class="p">,</span>
                            <span class="n">prev_translator</span><span class="o">.</span><span class="n">extractors</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prev_translator</span><span class="o">.</span><span class="n">vartypes</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                            <span class="n">left_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">name_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">UseAnotherTranslator</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="kc">False</span>
                    <span class="n">new_translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_reapply_filters</span><span class="p">(</span><span class="n">new_translator</span><span class="p">)</span>
                    <span class="n">new_translator</span> <span class="o">=</span> <span class="n">new_translator</span><span class="o">.</span><span class="n">apply_lambda</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span> <span class="n">new_filter_num</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">func_ast</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">original_names</span><span class="p">,</span> <span class="n">extractors</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">,</span> <span class="n">vartypes</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_translator</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_filter_num</span><span class="o">=</span><span class="n">new_filter_num</span><span class="p">,</span> <span class="n">_vars</span><span class="o">=</span><span class="n">new_vars</span><span class="p">,</span> <span class="n">_key</span><span class="o">=</span><span class="n">new_key</span><span class="p">,</span> <span class="n">_filters</span><span class="o">=</span><span class="n">new_filters</span><span class="p">,</span>
                            <span class="n">_translator</span><span class="o">=</span><span class="n">new_translator</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_reapply_filters</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">translator</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
            <span class="n">method_name</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">translator_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">translator</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="n">translator</span> <span class="o">=</span> <span class="n">translator_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translator</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">RawSQL</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">raw</span><span class="p">)</span>
            <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_process_lambda</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">return</span> <span class="n">query</span>

        <span class="n">entity</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Keyword arguments are not allowed: since query result type is not an entity, filter() method can accept only lambda&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_apply_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">RawSQL</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">raw</span><span class="p">)</span>
            <span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span> <span class="o">=</span> <span class="n">get_globals_and_locals</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">frame_depth</span><span class="o">=</span><span class="n">cut_traceback_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_process_lambda</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">original_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">return</span> <span class="n">query</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">quals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
            <span class="s1">&#39;Keyword arguments are not allowed: query iterates over more than one entity&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_apply_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">original_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_apply_kwargs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">original_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="k">if</span> <span class="n">original_names</span><span class="p">:</span>
            <span class="n">tablerefs</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">sqlquery</span><span class="o">.</span><span class="n">tablerefs</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="o">.</span><span class="n">name</span>
            <span class="n">tableref</span> <span class="o">=</span> <span class="n">tablerefs</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">tableref</span><span class="o">.</span><span class="n">entity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="n">get_attr</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_adict_</span><span class="o">.</span><span class="n">get</span>
        <span class="n">filterattrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">value_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">next_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_next_kwarg_id</span>
        <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">get_attr</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span>
                <span class="s1">&#39;Entity </span><span class="si">%s</span><span class="s1"> does not have attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> attribute </span><span class="si">%s</span><span class="s1"> cannot be used as a keyword argument for filtering&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">from_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">next_id</span>
            <span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">filterattrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">value_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">filterattrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">filterattrs</span><span class="p">)</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;apply_kwfilters&#39;</span><span class="p">,</span> <span class="n">filterattrs</span><span class="p">,</span> <span class="n">original_names</span><span class="p">),)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">HashableDict</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">_key</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">)</span>
        <span class="n">new_filters</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_filters</span> <span class="o">+</span> <span class="n">tup</span>
        <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value_dict</span><span class="p">)</span>
        <span class="n">new_translator</span><span class="p">,</span> <span class="n">new_vars</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_get_translator</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_translator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_translator</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">apply_kwfilters</span><span class="p">(</span><span class="n">filterattrs</span><span class="p">,</span> <span class="n">original_names</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_translator_cache</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_translator</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_key</span><span class="o">=</span><span class="n">new_key</span><span class="p">,</span> <span class="n">_filters</span><span class="o">=</span><span class="n">new_filters</span><span class="p">,</span> <span class="n">_translator</span><span class="o">=</span><span class="n">new_translator</span><span class="p">,</span>
                            <span class="n">_next_kwarg_id</span><span class="o">=</span><span class="n">next_id</span><span class="p">,</span> <span class="n">_vars</span><span class="o">=</span><span class="n">new_vars</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;If you want apply index to a query, convert it to list first&#39;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">step</span>
        <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;step&#39; of slice object is not allowed here&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Parameter &#39;start&#39; of slice object cannot be negative&quot;</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QueryResult</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">page</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">pagenum</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">pagenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pagesize</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">pagesize</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_aggregate</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">aggr_func_name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">attr_offsets</span><span class="p">,</span> <span class="n">query_key</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_construct_sql_and_arguments</span><span class="p">(</span>
            <span class="n">aggr_func_name</span><span class="o">=</span><span class="n">aggr_func_name</span><span class="p">,</span> <span class="n">aggr_func_distinct</span><span class="o">=</span><span class="n">distinct</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">_exec_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aggr_func_name</span> <span class="o">==</span> <span class="s1">&#39;SUM&#39;</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">aggr_func_name</span> <span class="o">==</span> <span class="s1">&#39;COUNT&#39;</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aggr_func_name</span> <span class="o">==</span> <span class="s1">&#39;AVG&#39;</span><span class="p">:</span>
                    <span class="n">expr_type</span> <span class="o">=</span> <span class="nb">float</span>
                <span class="k">elif</span> <span class="n">aggr_func_name</span> <span class="o">==</span> <span class="s1">&#39;GROUP_CONCAT&#39;</span><span class="p">:</span>
                    <span class="n">expr_type</span> <span class="o">=</span> <span class="n">basestring</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr_type</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span>
                <span class="n">provider</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">provider</span>
                <span class="n">converter</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_converter_by_py_type</span><span class="p">(</span><span class="n">expr_type</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">sql2py</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cache</span><span class="o">.</span><span class="n">query_results</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;SUM&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">avg</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;AVG&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">group_concat</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;`sep` option for `group_concat` should be of type str. Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;GROUP_CONCAT&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;MIN&#39;</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;MAX&#39;</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="s1">&#39;COUNT&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="p">)</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">for_update</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">nowait</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">provider</span><span class="o">.</span><span class="n">select_for_update_nowait_syntax</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="n">TranslationError</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> provider does not support SELECT FOR UPDATE NOWAIT syntax&#39;</span> <span class="o">%</span> <span class="n">provider</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_nowait</span><span class="o">=</span><span class="n">nowait</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;random()&#39;</span><span class="p">)[:</span><span class="n">limit</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">(),</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">query</span><span class="p">[:],</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">with_schema</span><span class="p">,</span> <span class="n">schema_hash</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">strcut</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">width</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>


<span class="k">class</span> <span class="nc">QueryResultIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;_query_result&#39;</span><span class="p">,</span> <span class="s1">&#39;_position&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_result</span> <span class="o">=</span> <span class="n">query_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">_get_type_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s1">&#39;Cannot use partially exhausted iterator, please convert to list&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_result</span><span class="o">.</span><span class="n">_get_type_</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_normalize_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">throw</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_result</span><span class="o">.</span><span class="n">_normalize_var</span><span class="p">(</span><span class="n">query_type</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_result</span>
        <span class="k">if</span> <span class="n">qr</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qr</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="n">qr</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="n">qr</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qr</span><span class="o">.</span><span class="n">_items</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>
    <span class="k">def</span> <span class="nf">__length_hint__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_result</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span>


<span class="k">def</span> <span class="nf">make_query_result_method_error_stub</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">throw</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;In order to do </span><span class="si">%s</span><span class="s1">, cast QueryResult to list first&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">func</span>

<span class="k">class</span> <span class="nc">QueryResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s1">&#39;_query&#39;</span><span class="p">,</span> <span class="s1">&#39;_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;_items&#39;</span><span class="p">,</span> <span class="s1">&#39;_expr_type&#39;</span><span class="p">,</span> <span class="s1">&#39;_col_names&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">lazy</span><span class="p">):</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">_translator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">lazy</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expr_type</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col_names</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">col_names</span>
    <span class="k">def</span> <span class="nf">_get_type_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QueryType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">)</span>
        <span class="n">item_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item_type</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_normalize_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
        <span class="n">item_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_translator</span><span class="o">.</span><span class="n">expr_type</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item_type</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">),</span> <span class="n">items</span>
    <span class="k">def</span> <span class="nf">_get_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expr_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_names</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expr_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_names</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QueryResultIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_other_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QueryResult</span><span class="p">)</span> <span class="k">else</span> <span class="n">other</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_items</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_items</span><span class="p">())</span>
    <span class="nd">@cut_traceback</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_actual_fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">width</span><span class="p">:</span> <span class="n">width</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">CONSOLE_WIDTH</span>
        <span class="n">max_columns</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">5</span>
        <span class="n">expr_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expr_type</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_names</span>

        <span class="k">def</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tostring</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr_type</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">expr_type</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_attrs_</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_collection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">lazy</span> <span class="p">][:</span><span class="n">max_columns</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="n">col_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row_maker</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">col_name</span><span class="p">),)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">row_maker</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="o">*</span><span class="n">col_names</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">to_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row_maker</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">to_str</span><span class="p">(</span><span class="n">obj</span><span class="p">),)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">to_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">]</span>

        <span class="n">remaining_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span> <span class="n">max_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colname</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_num</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">))</span>
            <span class="n">remaining_columns</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_len</span>

        <span class="n">width_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">available_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">remaining_columns</span><span class="p">:</span>
            <span class="n">base_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">available_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_columns</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_columns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">max_len</span> <span class="ow">in</span> <span class="n">remaining_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">max_len</span> <span class="o">&lt;=</span> <span class="n">base_len</span><span class="p">:</span>
                    <span class="n">width_dict</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_len</span>
                    <span class="k">del</span> <span class="n">remaining_columns</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span>
                    <span class="n">available_width</span> <span class="o">-=</span> <span class="n">max_len</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">remaining_columns</span><span class="p">:</span>
            <span class="n">base_len</span> <span class="o">=</span> <span class="n">available_width</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_columns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">max_len</span> <span class="ow">in</span> <span class="n">remaining_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">width_dict</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_len</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">strjoin</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">strcut</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">width_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_names</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">strjoin</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">width_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">)))))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">strjoin</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">strcut</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">width_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">))))</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">(),</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(),</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="o">.</span><span class="n">_database</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">with_schema</span><span class="p">,</span> <span class="n">schema_hash</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="fm">__setitem__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__setitem__&#39;</span><span class="p">,</span> <span class="s1">&#39;item assignment&#39;</span><span class="p">)</span>
    <span class="fm">__delitem__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__delitem__&#39;</span><span class="p">,</span> <span class="s1">&#39;item deletion&#39;</span><span class="p">)</span>
    <span class="fm">__iadd__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__iadd__&#39;</span><span class="p">,</span> <span class="s1">&#39;+=&#39;</span><span class="p">)</span>
    <span class="fm">__imul__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__imul__&#39;</span><span class="p">,</span> <span class="s1">&#39;*=&#39;</span><span class="p">)</span>
    <span class="fm">__mul__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__mul__&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;__rmul__&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">append</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">)</span>
    <span class="n">clear</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">)</span>
    <span class="n">extend</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;extend&#39;</span><span class="p">,</span> <span class="s1">&#39;extend&#39;</span><span class="p">)</span>
    <span class="n">insert</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">)</span>
    <span class="n">remove</span> <span class="o">=</span> <span class="n">make_query_result_method_error_stub</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">)</span>


<span class="nd">@cut_traceback</span>
<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">EntityMeta</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Entity</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;instance of &#39;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="c1"># width = options.CONSOLE_WIDTH</span>
        <span class="c1"># for attr in x._attrs_:</span>
        <span class="c1">#     if attr.is_collection or attr.lazy: continue</span>
        <span class="c1">#     value = str(attr.__get__(x)).replace(&#39;\n&#39;, &#39; &#39;)</span>
        <span class="c1">#     print(&#39;  %s: %s&#39; % (attr.name, strcut(value, width-len(attr.name)-4)))</span>
        <span class="c1"># print()</span>
        <span class="n">QueryResult</span><span class="p">([</span> <span class="n">x</span> <span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
        <span class="n">select</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span>
        <span class="n">x</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">special_functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">raw_sql</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">}</span>
<span class="n">const_functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">buffer</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">}</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">ETL Project</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../includeredme.html">ETL extract, transform, load (ETL) project - semester work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_manual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix.html">Appendix</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Piotr Pasterak.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>